{"job":{"components":{"64672":{"id":64672,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-32,"y":112,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64677],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"passenger_legevents"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT \n    'pjlvadd' AS eventtype\n\t,pjlv.versionstartutc AS eventdatetimeutc\n\t, pjlv.passengerid\n\t, pjlv.segmentid\n\t, pjlv.inventorylegid\n\t, pjlv.boardingsequence  --may not be relevant at all times\n\t, pjlv.createduserid \n\t, pjlv.modifieduserid --used to identify the user who created the record\n\t, pjlv.legnumber\t\n\t, pjlv.liftstatus\n\t, pjlv.unitdesignator\n    , pjlv.pjlvid\n    , pjlv.bookingstatus\n    \n    /* identify the previous booking status, if exists */\n\t,(SELECT TOP 1 bookingstatus\n\t\tFROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.segmentid = pjlv.segmentid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid\n\t\tAND pij.versionstartutc < pjlv.versionstartutc\n\t\tORDER BY versionstartutc DESC) \tAS prev_bookingstatus\n\t\n\t/* identify the previous lift status, if exists */\n\t,(SELECT TOP 1 liftstatus\n\t\tFROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.segmentid = pjlv.segmentid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid\n\t\tAND pij.versionstartutc < pjlv.versionstartutc\n\t\tORDER BY versionstartutc DESC) \tAS prev_liftstatus\n\t\t\n\t/* identify the previous seat , if exists */\n\t,(SELECT TOP 1 unitdesignator\n\t\tFROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.segmentid = pjlv.segmentid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid\n\t\tAND pij.versionstartutc < pjlv.versionstartutc\n\t\tORDER BY versionstartutc DESC) \tAS prev_unitdesignator\t\n\t\n\t/*######### flight details ###########*/\n\t,CAST(TRIM(il.flightnumber) AS int) AS flightnumber ,\n    TRIM(il.carriercode)  as carriercode, \n\til.departuredate,\n\til.stdutc,  \n    il.stdutc AS etdutc, \n\til.std,  \n    il.std AS etd,  \n\til.departurestation, \n\til.arrivalstation,\n    il.stautc,  \n\til.sta,\n\til.sta AS eta,\n    il.stautc AS etautc\n\n    /*########## pnr  details ##############*/\n\t--bookingdatetime\n   /*,(SELECT TOP 1 b.createdutc FROM ods.bookingpassenger AS bp\n   \t\t\t\t\t\tINNER JOIN ods.booking AS b\n\t\t\t\t\t\tON bp.bookingid =b.bookingid\n\t\tWHERE bp.passengerid = pjlv.passengerid) AS bookingdatetimeutc*/\n    ,pl.bookingcreateddatetimeutc\tAS bookingdatetimeutc    \n    --get bookingid for each \n    ,pl.bookingid AS bookingid\n    /*\n\t,(SELECT TOP 1 bp.bookingid FROM ods.bookingpassenger AS bp\n\t\tWHERE passengerid = pjlv.passengerid) AS bookingid*/\n\t\n\t/* ################# get relevancy to related pjsv ########*/\t\n\t\t\n\t--first datetime of the segmentid was effective\n\t,(SELECT MIN(versionstartutc) FROM ods.passengerjourneysegmentversion\n\t\tWHERE passengerid = pjlv.passengerid\n\t\tAND segmentid = pjlv.segmentid) AS segmentminstartdatetimeutc\n\t\t\n\t--last datetime of the segmentid values was effective\n\t,(SELECT MAX(versionstartutc) FROM ods.passengerjourneysegmentversion\n\t\tWHERE passengerid = pjlv.passengerid\n\t\tAND segmentid = pjlv.segmentid) AS segmentmaxstartdatetimeutc\t\n\t\n\t--first last datetime of the segmentid values expired\n\t,(SELECT MIN(versionendutc) FROM ods.passengerjourneysegmentversion AS pjs\n\t\tWHERE pjs.passengerid = pjlv.passengerid\n\t\tAND pjs.segmentid = pjlv.segmentid) AS segmentminenddatetimeutc\n\t\n\t--last datetime of the segmentid values expired\n\t,(SELECT MAX(versionendutc) FROM ods.passengerjourneysegmentversion AS pjs\n\t\tWHERE pjs.passengerid = pjlv.passengerid\n\t\tAND pjs.segmentid = pjlv.segmentid) AS segmentmaxenddatetimeutc\n\t\t\n\t/* ################# get relevancy to other related pjlv records ########*/\t\t\n\t\t\n\t--first datetime of the inventorylegid values was effective\n\t/*\n    ,(SELECT MIN(versionstartutc)  FROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid) AS legminstartdatetimeutc\n\t*/\t\n    --first datetime of the inventorylegid values was effective by segmentid\n\t,(SELECT MIN(versionstartutc)  FROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n        AND pij.segmentid = pjlv.segmentid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid) AS legminstartdatetimeutc\n    \n\t--last datetime of the inventorylegid values was effective\t\n\t,(SELECT MAX(versionstartutc) FROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid) AS legmaxstartdatetimeutc\n\t\t\n\t--last datetime of the inventorylegid values expired\t\n\t,(SELECT MAX(versionendutc) FROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid) AS legmaxenddatetimeutc\t\n\t\t\n    --returns a change reason if one exists for the passenger segment\n\t/*,ISNULL((SELECT MIN(changereasoncode) FROM ods.passengerjourneysegmentversion AS pjs\n\t\tWHERE pjs.passengerid = pjlv.passengerid\n\t\tAND pjs.segmentid = pjlv.segmentid\n\t\tAND pjs.versionstartutc = pjlv.versionstartutc),'') AS segmentchangereasoncode*/\n        \n      --returns a change reason if one exists for the passenger segment\n    ,(SELECT TOP 1 changereasoncode FROM ods.passengerjourneysegmentversion AS pjsv\n\t\tWHERE pjsv.passengerid = pjlv.passengerid\n\t\tAND pjsv.segmentid = pjlv.segmentid\n\t\tAND pjsv.versionstartutc <= pjlv.versionstartutc\n\t\tORDER BY pjsv.versionstartutc DESC) AS segmentchangereasoncode  \n    \n    ,(SELECT MIN(journeynumber) FROM ods.passengerjourneysegmentversion AS pjs  \n\t\tWHERE pjs.passengerid = pjlv.passengerid\n\t\tAND pjs.segmentid = pjlv.segmentid) AS journeynumber\n        \n\t,(SELECT MIN(segmentnumber) FROM ods.passengerjourneysegmentversion AS pjs \n\t\tWHERE pjs.passengerid = pjlv.passengerid\n\t\tAND pjs.segmentid = pjlv.segmentid) AS segmentnumber\n    /** passenger event related fields **/\n    ,pl.pnr\n    ,pl.parentbookingdatetimeutc\n    ,pl.bookingparentid\n    ,pl.parentpnrflag\n    ,pl.parentpnr\n    \n    /* product class info */\n\t,(SELECT TOP 1 pjsv.productclasscode\n\t\tFROM ods.passengerjourneysegmentversion AS pjsv\n\t\tWHERE pjsv.passengerid = pjlv.passengerid\n\t\tAND pjsv.segmentid = pjlv.segmentid\n\t\tAND ISNULL(pjsv.productclasscode,'') > ''\n\t\tAND pjsv.versionstartutc <= pjlv.versionstartutc\n\t\tORDER BY pjsv.versionstartutc DESC) AS productcodeclass\n        \nFROM ods.passengerjourneylegversion AS pjlv\n\tINNER JOIN ods.inventoryleg AS il\n\tON pjlv.inventorylegid = il.inventorylegid\n    /* this table needs to be removed and an incremental datetime added*/\n\tINNER JOIN stage.pnrpassengereventlist AS pl\n\tON pl.passengerid = pjlv.passengerid\nWHERE   --pjlv.bookingstatus='HK'  AND      -- Added on 2019-10-18\n EXISTS (SELECT 1 FROM stage.pnrpassengereventlist AS ppl\n\t\t\t  WHERE ppl.passengerid = pjlv.passengerid)\n\n\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64673":{"id":64673,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":288,"y":176,"width":32,"height":32,"inputConnectorIDs":[64678],"outputConnectorIDs":[64680],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"passengerlegeventflag"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT \n\nCASE WHEN eventdatetimeutc = bookingdatetimeutc THEN 1 ELSE 0 END AS BookingDateFlag\n/* BookingParentDateFlag added */\n\n,CASE WHEN eventdatetimeutc = parentbookingdatetimeutc THEN 1 ELSE 0 END AS BookingParentDateFlag\n,CASE WHEN ISNULL(prev_unitdesignator,'') = '' AND ISNULL(unitdesignator,'') <> '' \n\t  THEN 1 ELSE 0 END AS SeatAssignedFlag\n /* added 2019-07-25 */        \n,CASE WHEN ISNULL(prev_unitdesignator,'') <> '' AND ISNULL(unitdesignator,'') <> '' AND prev_unitdesignator <> unitdesignator \n\t  THEN 1 ELSE 0 END AS SeatChangedFlag\n\t  \n,CASE WHEN ISNULL(prev_unitdesignator,'') <> '' AND unitdesignator = '' \n\t  THEN 1 ELSE 0 END AS SeatUnAssignedFlag   \n\t  \n/* updated 2019-07-25 */        \n,CASE WHEN eventdatetimeutc >= bookingdatetimeutc AND liftstatus = 1 AND prev_liftstatus = 0 AND parentpnrflag = 0 THEN 1 \n\t  WHEN eventdatetimeutc >= parentbookingdatetimeutc AND liftstatus = 1 AND prev_liftstatus = 0 AND parentpnrflag = 1 THEN 1\n      ELSE 0 END AS CheckInFlag \n\t  \n,CASE WHEN eventdatetimeutc >= bookingdatetimeutc AND liftstatus = 2 AND prev_liftstatus = 1 THEN 1\n\t/* added 2019-10-30 include booking status changes to determine the change to a confirmed boarded event from standby*/\n      WHEN eventdatetimeutc >= bookingdatetimeutc AND liftstatus = 2 AND prev_liftstatus = 2\n      AND bookingstatus = 'HK' AND prev_bookingstatus = 'HL' THEN 1\n      ELSE 0 END AS BoardedFlag  \n      \n,CASE WHEN eventdatetimeutc >= bookingdatetimeutc AND liftstatus = 3 THEN 1\n\t  WHEN eventdatetimeutc >= bookingdatetimeutc AND liftstatus = 0 AND prev_liftstatus = 3 THEN 1\t\n\t  ELSE 0 END AS NoShowFlag\n\t  \n,CASE WHEN prev_liftstatus = 2 \tAND liftstatus = 0 AND eventdatetimeutc > bookingdatetimeutc THEN 1\n\t   /* TQ - added 2019-10-16 */ \n\t  WHEN prev_liftstatus = 2 \tAND liftstatus = 1 AND eventdatetimeutc > bookingdatetimeutc THEN 1 \n\t  ELSE 0 END AS UnboardedFlag\n\t  \n/* updated 2019-07-25 */    \n,CASE WHEN prev_liftstatus = 1 AND liftstatus = 0  AND eventdatetimeutc > bookingdatetimeutc AND parentpnrflag = 0\n\t  THEN 1 \n      WHEN prev_liftstatus = 1 AND liftstatus = 0  AND eventdatetimeutc > parentbookingdatetimeutc AND parentpnrflag = 1\n      THEN 1\n      END AS CheckoutFlag\n\t  \n,CASE WHEN liftstatus = 0 AND eventdatetimeutc > bookingdatetimeutc\n\t\t/* ms are slightly different between pjs and pjleg version tables */\n      AND to_char(segmentminstartdatetimeutc, 'YYYY-MM-DD HH24:MI:SS') = to_char(eventdatetimeutc, 'YYYY-MM-DD HH24:MI:SS')  \n\t  THEN 1 ELSE 0 END AS SegmentAddedFlag\n\t  \n,CASE WHEN \n\t  eventdatetimeutc > bookingdatetimeutc\n\t  AND to_char(segmentmaxenddatetimeutc, 'YYYY-MM-DD HH24:MI:SS') = to_char(eventdatetimeutc, 'YYYY-MM-DD HH24:MI:SS')  \n      AND segmentmaxstartdatetimeutc <= eventdatetimeutc \n\t  THEN 1 ELSE 0 END AS SegmentDroppedFlag\n\t  \n/*needed when a leg/flight stays the same but the segment changes*/        \n,CASE WHEN eventdatetimeutc > bookingdatetimeutc\n\t  AND to_char(segmentmaxstartdatetimeutc, 'YYYY-MM-DD HH24:MI:SS') = to_char(eventdatetimeutc, 'YYYY-MM-DD HH24:MI:SS')  \n      AND segmentmaxstartdatetimeutc > segmentminstartdatetimeutc\n\t  THEN 1 ELSE 0 END AS SegmentChangeFlag\n\t  \n/* added logic to support split PNRs */        \n,CASE WHEN ISNULL(liftstatus,0) = 0 \n      AND parentpnrflag = 0 /* pnr was not split */\n\t  AND eventdatetimeutc > bookingdatetimeutc\n\t  AND to_char(legminstartdatetimeutc, 'YYYY-MM-DD HH24:MI:SS') = to_char(eventdatetimeutc, 'YYYY-MM-DD HH24:MI:SS')\n       --AND legmaxenddatetimeutc = '9999-12-31' /* removed because flights can be added and then dropped */\n\t  THEN 1 \n      WHEN ISNULL(liftstatus,0) = 0 \n      AND parentpnrflag = 1 /* pnr was split */\n\t  AND eventdatetimeutc > parentbookingdatetimeutc\n\t  AND to_char(legminstartdatetimeutc, 'YYYY-MM-DD HH24:MI:SS') = to_char(eventdatetimeutc, 'YYYY-MM-DD HH24:MI:SS')\n      THEN 1\n      ELSE 0 END AS LegAddedFlag\n\n ,CASE WHEN liftstatus = 0 \n\t  AND eventdatetimeutc > bookingdatetimeutc\n\t  AND to_char(legminstartdatetimeutc, 'YYYY-MM-DD HH24:MI:SS') = to_char(eventdatetimeutc, 'YYYY-MM-DD HH24:MI:SS')\n      AND legmaxenddatetimeutc > eventdatetimeutc \n      AND legmaxenddatetimeutc < '9999-12-31'\n\t  THEN 1 ELSE 0 END AS LegAddedTempFlag \n\n,CASE WHEN \teventdatetimeutc >= legmaxstartdatetimeutc \tAND eventdatetimeutc = legmaxenddatetimeutc\n      AND legmaxenddatetimeutc < '9999-12-31'\n\t  THEN 1 ELSE 0 END AS LegDroppedFlag\n        \n,CASE WHEN legmaxenddatetimeutc = '9999-12-31'  AND segmentmaxenddatetimeutc = '9999-12-31' AND liftstatus = 2 \n--AND prev_liftstatus = 1\n      THEN 1 ELSE 0 END AS FlightFlownFlag\n      \n, CASE WHEN bookingstatus = 'HL' then 1 ELSE 0 END AS standbyflag\n,*\n\nFROM $T{passengerlegevent}"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64674":{"id":64674,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-1841822228,"x":144,"y":176,"width":32,"height":32,"inputConnectorIDs":[64677,64679],"outputConnectorIDs":[64678],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"passengerlegevent"}}}},"visible":true},"2":{"slot":2,"name":"Method","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"All Columns"}}}},"visible":true},"3":{"slot":3,"name":"Cast Types","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Add Source Component Column","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Remove duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64675":{"id":64675,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-32,"y":240,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64679],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"passenger_droplegevent"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT \n    'pjlvdrop' AS eventtype\n\t, pjlv.versionendutc AS eventdatetimeutc\n\t, pjlv.passengerid\n\t, pjlv.segmentid\n\t, pjlv.inventorylegid\n\t, pjlv.boardingsequence \n\t, pjlv.createduserid \n\t/*, pjlv.modifieduserid */\n    /* user id who deleted the flight record \n\tassumes there is still a segment and journey for the passenger */\n\t,ISNULL((SELECT TOP 1 pjsv.modifieduserid\n\t\tFROM ods.passengerjourneysegmentversion AS pjsv\n\t\tWHERE pjsv.passengerid = pjlv.passengerid\n\t\tAND pjsv.versionstartutc >= pjlv.versionendutc\n\t\tORDER BY pjsv.versionstartutc),pjlv.modifieduserid) AS modifieduserid\n        \n\t, pjlv.legnumber\t\n\t, pjlv.liftstatus\n\t, pjlv.unitdesignator\n    , pjlv.pjlvid\n    , pjlv.bookingstatus\n\t\n\t/*######### flight details ###########*/\n\t,CAST(TRIM(il.flightnumber) AS int) AS flightnumber ,\n    TRIM(il.carriercode)  as carriercode, \n\til.departuredate,\n\til.stdutc,  \n    il.stdutc AS etdutc,\n\til.std,  \n    il.std AS etd, \n\til.departurestation, \n\til.arrivalstation,\n\t\n    il.stautc,  \n\til.sta,\n    il.sta AS eta,\n    il.stautc AS etautc\n    /*########## pnr  details ##############*/\n\t--bookingdatetime\n   /*,(SELECT TOP 1 b.createdutc FROM ods.bookingpassenger AS bp\n   \t\t\t\t\t\tINNER JOIN ods.booking AS b\n\t\t\t\t\t\tON bp.bookingid =b.bookingid\n\t\tWHERE bp.passengerid = pjlv.passengerid) AS bookingdatetimeutc*/\n    ,pl.bookingcreateddatetimeutc\tAS bookingdatetimeutc    \n    --get bookingid for each \n\t/*,(SELECT TOP 1 bp.bookingid FROM ods.bookingpassenger AS bp\n\t\tWHERE passengerid = pjlv.passengerid) AS bookingid*/\n\t,pl.bookingid AS bookingid\n    \n    /* identify the previous booking status, if exists */\n\t,(SELECT TOP 1 bookingstatus\n\t\tFROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.segmentid = pjlv.segmentid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid\n\t\tAND pij.versionstartutc < pjlv.versionstartutc\n\t\tORDER BY versionstartutc DESC) \tAS prev_bookingstatus\n    \n    \t/* identify the previous lift status, if exists */\n\t,(SELECT TOP 1 liftstatus\n\t\tFROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.segmentid = pjlv.segmentid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid\n\t\tAND pij.versionstartutc < pjlv.versionstartutc\n\t\tORDER BY versionstartutc DESC) \tAS prev_liftstatus\n\t\t\n\t/* identify the previous seat , if exists */\n\t,(SELECT TOP 1 unitdesignator\n\t\tFROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.segmentid = pjlv.segmentid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid\n\t\tAND pij.versionstartutc < pjlv.versionstartutc\n\t\tORDER BY versionstartutc DESC) \tAS prev_unitdesignator\t\n        \n\t/* ################# get relevancy to related pjsv ########*/\t\n\t\t\n\t--first datetime of the segmentid was effective\n\t,(SELECT MIN(versionstartutc) FROM ods.passengerjourneysegmentversion\n\t\tWHERE passengerid = pjlv.passengerid\n\t\tAND segmentid = pjlv.segmentid) AS segmentminstartdatetimeutc\n\t\t\n\t--last datetime of the segmentid values was effective\n\t,(SELECT MAX(versionstartutc) FROM ods.passengerjourneysegmentversion\n\t\tWHERE passengerid = pjlv.passengerid\n\t\tAND segmentid = pjlv.segmentid) AS segmentmaxstartdatetimeutc\t\n\t\n\t--first last datetime of the segmentid values expired\n\t,(SELECT MIN(versionendutc) FROM ods.passengerjourneysegmentversion AS pjs\n\t\tWHERE pjs.passengerid = pjlv.passengerid\n\t\tAND pjs.segmentid = pjlv.segmentid) AS segmentminenddatetimeutc\n\t\n\t--last datetime of the segmentid values expired\n\t,(SELECT MAX(versionendutc) FROM ods.passengerjourneysegmentversion AS pjs\n\t\tWHERE pjs.passengerid = pjlv.passengerid\n\t\tAND pjs.segmentid = pjlv.segmentid) AS segmentmaxenddatetimeutc\n        \n     --returns a change reason if one exists for the passenger segment\n    ,(SELECT TOP 1 changereasoncode FROM ods.passengerjourneysegmentversion AS pjsv\n\t\tWHERE pjsv.passengerid = pjlv.passengerid\n\t\tAND pjsv.segmentid = pjlv.segmentid\n\t\tAND pjsv.versionstartutc <= pjlv.versionstartutc\n\t\tORDER BY pjsv.versionstartutc DESC) AS segmentchangereasoncode    \n        \n\t\t\n\t/* ################# get relevancy to other related pjlv records ########*/\t\t\n\t\t\n\t--first datetime of the inventorylegid values was effective\n\t,(SELECT MIN(versionstartutc)  FROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n        AND pij.segmentid = pjlv.segmentid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid) AS legminstartdatetimeutc\n\t\t\n\t--last datetime of the inventorylegid values was effective\t\n\t/*,(SELECT MAX(versionstartutc) FROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid) AS legmaxstartdatetimeutc\n\t*/\n    ,(SELECT MAX(versionstartutc) FROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.segmentid = pjlv.segmentid\n        AND pij.inventorylegid = pjlv.inventorylegid) AS legmaxstartdatetimeutc\n        \n\t--last datetime of the inventorylegid values expired use the segmentid \t\n\t/*,(SELECT MAX(versionendutc) FROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t\tAND pij.inventorylegid = pjlv.inventorylegid) AS legmaxenddatetimeutc\t*/\n    ,(SELECT MAX(versionendutc) FROM ods.passengerjourneylegversion AS pij\n\t\tWHERE pij.passengerid = pjlv.passengerid\n\t  AND pij.segmentid = pjlv.segmentid\t\n      AND pij.inventorylegid = pjlv.inventorylegid) AS legmaxenddatetimeutc    \n        \n    ,(SELECT MIN(journeynumber) FROM ods.passengerjourneysegmentversion AS pjs  \n\t\tWHERE pjs.passengerid = pjlv.passengerid\n\t\tAND pjs.segmentid = pjlv.segmentid) AS journeynumber\n        \n\t,(SELECT MIN(segmentnumber) FROM ods.passengerjourneysegmentversion AS pjs \n\t\tWHERE pjs.passengerid = pjlv.passengerid\n\t\tAND pjs.segmentid = pjlv.segmentid) AS segmentnumber\n       \n    /** passenger event related fields **/\n    ,pl.pnr\n\t,pl.parentbookingdatetimeutc\n    ,pl.bookingparentid\n    ,pl.parentpnrflag\n    ,pl.parentpnr\n    \n     /* product class info */\n\t,(SELECT TOP 1 pjsv.productclasscode\n\t\tFROM ods.passengerjourneysegmentversion AS pjsv\n\t\tWHERE pjsv.passengerid = pjlv.passengerid\n\t\tAND pjsv.segmentid = pjlv.segmentid\n\t\tAND ISNULL(pjsv.productclasscode,'') > ''\n\t\tAND pjsv.versionstartutc <= pjlv.versionstartutc\n\t\tORDER BY pjsv.versionstartutc DESC) AS productcodeclass\n        \nFROM ods.passengerjourneylegversion AS pjlv\n\tINNER JOIN ods.inventoryleg AS il\n\tON pjlv.inventorylegid = il.inventorylegid\n\tINNER JOIN  stage.pnrpassengereventlist AS pl\n\tON pl.passengerid = pjlv.passengerid\n/* identify only leg records that have been deleted for the pjl records*/\nWHERE  -- pjlv.bookingstatus='HK'  AND    -- Added on 2019-10-18\n EXISTS (SELECT 1 FROM \n\t\t\t\t(SELECT segmentid, inventorylegid, MAX(versionendutc) AS maxversionendutc \n\t\t\t\tFROM ods.passengerjourneylegversion AS pj\n\t\t\t\tWHERE EXISTS (SELECT 1 FROM stage.pnrpassengereventlist AS ppel\n\t\t\t\t\t\t\t\tWHERE pj.passengerid = ppel.passengerid)\n\t\t\t\tGROUP BY segmentid, inventorylegid) AS pjl\n\t\t  \tWHERE pjl.segmentid = pjlv.segmentid\n\t\t\tAND pjl.inventorylegid = pjlv.inventorylegid\n\t\t\tAND pjl.maxversionendutc = pjlv.versionendutc\n\t\t\tAND pjl.maxversionendutc < '9999-12-31')\n\n                        \n\n\n        "}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64676":{"id":64676,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":512,"y":176,"width":32,"height":32,"inputConnectorIDs":[64680],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage.pnrpassengerevent"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengerevent"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"},"2":{"slot":2,"type":"STRING","value":"eventtype"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"eventdatetimeutc"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"pnr"},"2":{"slot":2,"type":"STRING","value":"pnr"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"},"2":{"slot":2,"type":"STRING","value":"passengerid"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"},"2":{"slot":2,"type":"STRING","value":"segmentid"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"inventorylegid"},"2":{"slot":2,"type":"STRING","value":"inventorylegid"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"boardingsequence"},"2":{"slot":2,"type":"STRING","value":"boardingsequence"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"createduserid"},"2":{"slot":2,"type":"STRING","value":"createduserid"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"modifieduserid"},"2":{"slot":2,"type":"STRING","value":"modifieduserid"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"journeynumber"},"2":{"slot":2,"type":"STRING","value":"journeynumber"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"segmentnumber"},"2":{"slot":2,"type":"STRING","value":"segmentnumber"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"},"2":{"slot":2,"type":"STRING","value":"legnumber"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"liftstatus"},"2":{"slot":2,"type":"STRING","value":"liftstatus"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"prev_liftstatus"},"2":{"slot":2,"type":"STRING","value":"prev_liftstatus"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"unitdesignator"},"2":{"slot":2,"type":"STRING","value":"unitdesignator"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"prev_unitdesignator"},"2":{"slot":2,"type":"STRING","value":"prev_unitdesignator"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"},"2":{"slot":2,"type":"STRING","value":"flightnumber"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"departuredate"},"2":{"slot":2,"type":"STRING","value":"departuredate"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"stdutc"},"2":{"slot":2,"type":"STRING","value":"stdutc"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"std"},"2":{"slot":2,"type":"STRING","value":"std"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"},"2":{"slot":2,"type":"STRING","value":"departurestation"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"},"2":{"slot":2,"type":"STRING","value":"arrivalstation"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"bookingdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"bookingdatetimeutc"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"bookingid"},"2":{"slot":2,"type":"STRING","value":"bookingid"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"segmentminstartdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"segmentminstartdatetimeutc"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"segmentmaxstartdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"segmentmaxstartdatetimeutc"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"segmentminenddatetimeutc"},"2":{"slot":2,"type":"STRING","value":"segmentminenddatetimeutc"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"segmentmaxenddatetimeutc"},"2":{"slot":2,"type":"STRING","value":"segmentmaxenddatetimeutc"}}},"29":{"slot":29,"values":{"1":{"slot":1,"type":"STRING","value":"legminstartdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"legminstartdatetimeutc"}}},"30":{"slot":30,"values":{"1":{"slot":1,"type":"STRING","value":"legmaxstartdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"legmaxstartdatetimeutc"}}},"31":{"slot":31,"values":{"1":{"slot":1,"type":"STRING","value":"legmaxenddatetimeutc"},"2":{"slot":2,"type":"STRING","value":"legmaxenddatetimeutc"}}},"32":{"slot":32,"values":{"1":{"slot":1,"type":"STRING","value":"segmentchangereasoncode"},"2":{"slot":2,"type":"STRING","value":"segmentchangereasoncode"}}},"33":{"slot":33,"values":{"1":{"slot":1,"type":"STRING","value":"bookingdateflag"},"2":{"slot":2,"type":"STRING","value":"bookingdateflag"}}},"34":{"slot":34,"values":{"1":{"slot":1,"type":"STRING","value":"seatassignedflag"},"2":{"slot":2,"type":"STRING","value":"seatassignedflag"}}},"35":{"slot":35,"values":{"1":{"slot":1,"type":"STRING","value":"checkinflag"},"2":{"slot":2,"type":"STRING","value":"checkinflag"}}},"36":{"slot":36,"values":{"1":{"slot":1,"type":"STRING","value":"boardedflag"},"2":{"slot":2,"type":"STRING","value":"boardedflag"}}},"37":{"slot":37,"values":{"1":{"slot":1,"type":"STRING","value":"noshowflag"},"2":{"slot":2,"type":"STRING","value":"noshowflag"}}},"38":{"slot":38,"values":{"1":{"slot":1,"type":"STRING","value":"unboardedflag"},"2":{"slot":2,"type":"STRING","value":"unboardedflag"}}},"39":{"slot":39,"values":{"1":{"slot":1,"type":"STRING","value":"checkoutflag"},"2":{"slot":2,"type":"STRING","value":"checkoutflag"}}},"40":{"slot":40,"values":{"1":{"slot":1,"type":"STRING","value":"segmentaddedflag"},"2":{"slot":2,"type":"STRING","value":"segmentaddedflag"}}},"41":{"slot":41,"values":{"1":{"slot":1,"type":"STRING","value":"segmentdroppedflag"},"2":{"slot":2,"type":"STRING","value":"segmentdroppedflag"}}},"42":{"slot":42,"values":{"1":{"slot":1,"type":"STRING","value":"segmentchangeflag"},"2":{"slot":2,"type":"STRING","value":"segmentchangeflag"}}},"43":{"slot":43,"values":{"1":{"slot":1,"type":"STRING","value":"legaddedflag"},"2":{"slot":2,"type":"STRING","value":"legaddedflag"}}},"44":{"slot":44,"values":{"1":{"slot":1,"type":"STRING","value":"legaddedtempflag"},"2":{"slot":2,"type":"STRING","value":"legaddedtempflag"}}},"45":{"slot":45,"values":{"1":{"slot":1,"type":"STRING","value":"legdroppedflag"},"2":{"slot":2,"type":"STRING","value":"legdroppedflag"}}},"46":{"slot":46,"values":{"1":{"slot":1,"type":"STRING","value":"flightflownflag"},"2":{"slot":2,"type":"STRING","value":"flightflownflag"}}},"47":{"slot":47,"values":{"1":{"slot":1,"type":"STRING","value":"pjlvid"},"2":{"slot":2,"type":"STRING","value":"pjlvid"}}},"48":{"slot":48,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"},"2":{"slot":2,"type":"STRING","value":"carriercode"}}},"49":{"slot":49,"values":{"1":{"slot":1,"type":"STRING","value":"parentbookingdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"parentbookingdatetimeutc"}}},"50":{"slot":50,"values":{"1":{"slot":1,"type":"STRING","value":"bookingparentid"},"2":{"slot":2,"type":"STRING","value":"bookingparentid"}}},"51":{"slot":51,"values":{"1":{"slot":1,"type":"STRING","value":"parentpnrflag"},"2":{"slot":2,"type":"STRING","value":"parentpnrflag"}}},"52":{"slot":52,"values":{"1":{"slot":1,"type":"STRING","value":"parentpnr"},"2":{"slot":2,"type":"STRING","value":"parentpnr"}}},"53":{"slot":53,"values":{"1":{"slot":1,"type":"STRING","value":"bookingparentdateflag"},"2":{"slot":2,"type":"STRING","value":"bookingparentdateflag"}}},"54":{"slot":54,"values":{"1":{"slot":1,"type":"STRING","value":"seatchangedflag"},"2":{"slot":2,"type":"STRING","value":"seatchangedflag"}}},"55":{"slot":55,"values":{"1":{"slot":1,"type":"STRING","value":"sta"},"2":{"slot":2,"type":"STRING","value":"sta"}}},"56":{"slot":56,"values":{"1":{"slot":1,"type":"STRING","value":"stautc"},"2":{"slot":2,"type":"STRING","value":"stautc"}}},"57":{"slot":57,"values":{"1":{"slot":1,"type":"STRING","value":"productcodeclass"},"2":{"slot":2,"type":"STRING","value":"productclasscode"}}},"58":{"slot":58,"values":{"1":{"slot":1,"type":"STRING","value":"eta"},"2":{"slot":2,"type":"STRING","value":"eta"}}},"59":{"slot":59,"values":{"1":{"slot":1,"type":"STRING","value":"etautc"},"2":{"slot":2,"type":"STRING","value":"etautc"}}},"60":{"slot":60,"values":{"1":{"slot":1,"type":"STRING","value":"etd"},"2":{"slot":2,"type":"STRING","value":"etd"}}},"61":{"slot":61,"values":{"1":{"slot":1,"type":"STRING","value":"etdutc"},"2":{"slot":2,"type":"STRING","value":"etdutc"}}},"62":{"slot":62,"values":{"1":{"slot":1,"type":"STRING","value":"bookingstatus"},"2":{"slot":2,"type":"STRING","value":"bookingstatus"}}},"63":{"slot":63,"values":{"1":{"slot":1,"type":"STRING","value":"prev_bookingstatus"},"2":{"slot":2,"type":"STRING","value":"prev_bookingstatus"}}},"64":{"slot":64,"values":{"1":{"slot":1,"type":"STRING","value":"standbyflag"},"2":{"slot":2,"type":"STRING","value":"standbyflag"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"64677":{"id":64677,"sourceID":64672,"targetID":64674},"64678":{"id":64678,"sourceID":64674,"targetID":64673},"64679":{"id":64679,"sourceID":64675,"targetID":64674},"64680":{"id":64680,"sourceID":64673,"targetID":64676}},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"64667":{"id":64667,"x":-158,"y":-158,"width":552,"height":145,"text":"identify the pnr passenger leg events\n\nevents are separated from add and drops events, based on the versionstartutc and versionendutc columns\n\nadditional subqueries and lookups are included in the queries to get additional information on relevant pjl records\n\n\n\nupdate:2019-10-29","colour":"e6e63c"},"64668":{"id":64668,"x":-151,"y":13,"width":229,"height":143,"text":"Bookings, checkin, boarded, no show and flight additions\n\nthe versionstartutc is used to identify adds and modified passenger ","colour":"e6e63c"},"64669":{"id":64669,"x":413,"y":76,"width":206,"height":174,"text":"**For testing purpose, we use update/insert\n We will change this to truncate when run in production\n**\n","colour":"e6e63c"},"64670":{"id":64670,"x":-151,"y":209,"width":307,"height":258,"text":"\n\n\n\n\n\n\ndrop flight events\n\nthe versionendutc is used to identify the drop event datetime. only records that have been deleted without a 9999-12-31 record are used for drop events\n\nneed to review if all of the subqueries are needed. the less subqueries the better the performance","colour":"e6e63c"},"64671":{"id":64671,"x":227,"y":77,"width":137,"height":176,"text":"add indicators to identify the event of the record","colour":"e6e63c"}},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"PNR - Passenger Flight Event Extract","description":"extract the passengerjourneylegversion records to create the add, drop and change flight events","type":"TRANSFORMATION"}}