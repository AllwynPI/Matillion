{"job":{"components":{"64804":{"id":64804,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":-144,"y":272,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64810,64812],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage.pnrpassengerevent"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengerevent"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"departuredate"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"std"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"sta"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"standbyflag"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64805":{"id":64805,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":144,"y":176,"width":32,"height":32,"inputConnectorIDs":[64812],"outputConnectorIDs":[64811],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"add flightdetailhistory etd/eta"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/*****************************************************************************\n\tjoin the event records with the flight detail history table to get the\n    state of the flight at the time the event occurred\n    \n    join on the public irop and delay code tables to get the controllable category\n\n*****************************************************************************/\nSELECT \npfe.eventtype\n,pfe.eventdatetimeutc\n,pfe.departuredate\n,pfe.flightnumber\n,pfe.carriercode\n,pfe.departurestation\n,pfe.segmentid\n,pfe.legnumber\n,pfe.passengerid\n,ISNULL(pfe.standbyflag,0) AS standbyflag\n,fdh.std AS std\n,fdh.sta AS sta\n,fdh.etd AS etd\n,fdh.eta AS eta\n,fdh.stdutc AS stdutc\n,fdh.stautc AS stautc\n,fdh.etdutc AS etdutc\n,fdh.etautc AS etautc\n,fdh.outtime\n,fdh.offtime\n,fdh.ontime\n,fdh.intime\n,fdh.departureoveralldelaytime\n,fdh.departureoveralldelaycode \n,fdh.departureoveralldelaycontrollable \n,CASE WHEN ISNULL(depdelay.controllableflag,0) = 0 THEN 0 \n\t\tWHEN depdelay.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS departureoveralldelaycontrolcategory\n--,fdh.departureoveralldelaymaintenance     --01oct19 col removed\n,fdh.departuredelaycode1 \n,fdh.departuredelaytime1 \n,fdh.departuredelaycontrollable1 \n,CASE WHEN ISNULL(depdelay1.controllableflag,0) = 0 THEN 0 \n\t\tWHEN depdelay1.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS departuredelaycontrolcategory1\n,fdh.departuredelaycode2 \n,fdh.departuredelaytime2 \n,fdh.departuredelaycontrollable2 \n,CASE WHEN ISNULL(depdelay2.controllableflag,0) = 0 THEN 0 \n\t\tWHEN depdelay2.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS departuredelaycontrolcategory2\n,fdh.departuredelaycode3 \n,fdh.departuredelaytime3 \n,fdh.departuredelaycontrollable3\n,CASE WHEN ISNULL(depdelay3.controllableflag,0) = 0 THEN 0 \n\t\tWHEN depdelay3.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS departuredelaycontrolcategory3\n--,fdh.arrivalvsscheduled\n,fdh.arrivaloveralldelaytime\n,fdh.arrivaloveralldelaycode\n,fdh.arrivaloveralldelaycontrollable \n,CASE WHEN ISNULL(arrdelay.controllableflag,0) = 0 THEN 0 \n\t\tWHEN arrdelay.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS arrivaloveralldelaycontrolcategory\n,fdh.arrivaldelaycode1\n,fdh.arrivaldelaytime1\n,fdh.arrivaldelaycontrollable1\n,CASE WHEN ISNULL(arrdelay1.controllableflag,0) = 0 THEN 0 \n\t\tWHEN arrdelay1.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS arrivaldelaycontrolcategory1\n,fdh.arrivaldelaycode2\n,fdh.arrivaldelaytime2\n,fdh.arrivaldelaycontrollable2\n,CASE WHEN ISNULL(arrdelay2.controllableflag,0) = 0 THEN 0 \n\t\tWHEN arrdelay2.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS arrivaldelaycontrolcategory2\n,fdh.iropcode\n,CASE WHEN ic.controllableflag = 0 THEN 0 \n\t\tWHEN ic.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS iropcodecontrolcategory\t\n,(fdh.arrivaloveralldelaytime + fdh.arrivaldelaytime1 + fdh.arrivaldelaytime2) AS TotalArrivalDelayMinute\n\n,(CASE WHEN fdh.arrivaloveralldelaycontrollable = 1 THEN fdh.arrivaloveralldelaytime ELSE 0 END\n+ CASE WHEN fdh.arrivaldelaycontrollable1 = 1 THEN fdh.arrivaldelaytime1 ELSE 0 END\n+ CASE WHEN fdh.arrivaldelaycontrollable2 = 1 THEN fdh.arrivaldelaytime2 ELSE 0 END)\nAS ArrivalDelayControllableMinute\n,CAST(0 AS int) AS ArrivalDelayControllableSafetyMinute  /*will be updated after the controllable safety codes have been added */\n,(CASE WHEN fdh.arrivaloveralldelaycontrollable = 0 THEN fdh.arrivaloveralldelaytime ELSE 0 END\n+ CASE WHEN fdh.arrivaldelaycontrollable1 = 0 THEN fdh.arrivaldelaytime1 ELSE 0 END\n+ CASE WHEN fdh.arrivaldelaycontrollable2 = 0 THEN fdh.arrivaldelaytime2 ELSE 0 END)\nAS ArrivalDelayUnControllableMinute\n\n--,departurevsscheduled\n, CASE WHEN ISNULL(departureoveralldelaycode,'') <> '' THEN 1 ELSE 0 END AS flightdeparturedelayflag \n\nFROM $T{stage.pnrpassengerevent}  AS pfe\nINNER JOIN public.flightdetailhistory AS fdh\nON pfe.carriercode = fdh.carriercode\nAND pfe.flightnumber = fdh.flightnumber\nAND pfe.departuredate = fdh.flightdate\nAND pfe.departurestation = fdh.departurestation\nAND pfe.arrivalstation = fdh.arrivalstation\n--AND pfe.eventdatetimeutc BETWEEN cast(to_char(fdh.effectivedatetimeutc,'YYYY-MM-DD HH24:MI:SS') AS DATE) AND cast(to_char(fdh.expireddatetimeutc,'YYYY-MM-DD HH24:MI:SS') AS DATE)\nAND pfe.eventdatetimeutc BETWEEN fdh.effectivedatetimeutc  AND fdh.expireddatetimeutc\nAND fdh.activeflag = 1\n--irop code\nLEFT JOIN public.iropcode AS ic\nON ic.iropcode = fdh.iropcode\n--departure\nLEFT JOIN public.delaycode AS depdelay\nON depdelay.delaycode = fdh.departureoveralldelaycode\nLEFT JOIN public.delaycode AS depdelay1\nON depdelay1.delaycode = fdh.departuredelaycode1\nLEFT JOIN public.delaycode AS depdelay2\nON depdelay2.delaycode = fdh.departuredelaycode2\nLEFT JOIN public.delaycode AS depdelay3\nON depdelay3.delaycode = fdh.departuredelaycode3\n--arrival\nLEFT JOIN public.delaycode AS arrdelay\nON arrdelay.delaycode = fdh.arrivaloveralldelaycode\nLEFT JOIN public.delaycode AS arrdelay1\nON arrdelay1.delaycode = fdh.arrivaldelaycode1\nLEFT JOIN public.delaycode AS arrdelay2\nON arrdelay2.delaycode = fdh.arrivaldelaycode2\nwhere pfe.carriercode = 'PD'\nAND pfe.eventtype not in ('flightarrivalevent','flightarrival','flightcancelevent')"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64806":{"id":64806,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":496,"y":176,"width":32,"height":32,"inputConnectorIDs":[64811],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"update stage.pnrpassengereventcalc"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengereventcalc"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"},"2":{"slot":2,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"},"2":{"slot":2,"type":"STRING","value":"segmentid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"},"2":{"slot":2,"type":"STRING","value":"flightnumber"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"departuredate"},"2":{"slot":2,"type":"STRING","value":"departuredate"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"outtime"},"2":{"slot":2,"type":"STRING","value":"outtime"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"intime"},"2":{"slot":2,"type":"STRING","value":"intime"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaloveralldelaytime"},"2":{"slot":2,"type":"STRING","value":"arrivaloveralldelaytime"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaloveralldelaycode"},"2":{"slot":2,"type":"STRING","value":"arrivaloveralldelaycode"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaloveralldelaycontrollable"},"2":{"slot":2,"type":"STRING","value":"arrivaloveralldelaycontrollable"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycode1"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycode1"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaytime1"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaytime1"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycode2"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycode2"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaytime2"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaytime2"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"iropcode"},"2":{"slot":2,"type":"STRING","value":"iropcode"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"totalarrivaldelayminute"},"2":{"slot":2,"type":"STRING","value":"totalarrivaldelayminute"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycontrollablesafetyminute"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycontrollablesafetyminute"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelayuncontrollableminute"},"2":{"slot":2,"type":"STRING","value":"arrivaldelayuncontrollableminute"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycontrollableminute"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycontrollableminute"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"ontime"},"2":{"slot":2,"type":"STRING","value":"ontime"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"departureoveralldelaytime"},"2":{"slot":2,"type":"STRING","value":"departureoveralldelaytime"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"departureoveralldelaycode"},"2":{"slot":2,"type":"STRING","value":"departureoveralldelaycode"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"departureoveralldelaycontrollable"},"2":{"slot":2,"type":"STRING","value":"departureoveralldelaycontrollable"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycode1"},"2":{"slot":2,"type":"STRING","value":"departuredelaycode1"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaytime1"},"2":{"slot":2,"type":"STRING","value":"departuredelaytime1"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycode2"},"2":{"slot":2,"type":"STRING","value":"departuredelaycode2"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaytime2"},"2":{"slot":2,"type":"STRING","value":"departuredelaytime2"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycode3"},"2":{"slot":2,"type":"STRING","value":"departuredelaycode3"}}},"29":{"slot":29,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaytime3"},"2":{"slot":2,"type":"STRING","value":"departuredelaytime3"}}},"30":{"slot":30,"values":{"1":{"slot":1,"type":"STRING","value":"offtime"},"2":{"slot":2,"type":"STRING","value":"offtime"}}},"31":{"slot":31,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"},"2":{"slot":2,"type":"STRING","value":"carriercode"}}},"32":{"slot":32,"values":{"1":{"slot":1,"type":"STRING","value":"flightdeparturedelayflag"},"2":{"slot":2,"type":"STRING","value":"flightdeparturedelayflag"}}},"33":{"slot":33,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"},"2":{"slot":2,"type":"STRING","value":"legnumber"}}},"34":{"slot":34,"values":{"1":{"slot":1,"type":"STRING","value":"eta"},"2":{"slot":2,"type":"STRING","value":"eta"}}},"35":{"slot":35,"values":{"1":{"slot":1,"type":"STRING","value":"etd"},"2":{"slot":2,"type":"STRING","value":"etd"}}},"36":{"slot":36,"values":{"1":{"slot":1,"type":"STRING","value":"sta"},"2":{"slot":2,"type":"STRING","value":"sta"}}},"37":{"slot":37,"values":{"1":{"slot":1,"type":"STRING","value":"std"},"2":{"slot":2,"type":"STRING","value":"std"}}},"38":{"slot":38,"values":{"1":{"slot":1,"type":"STRING","value":"iropcodecontrolcategory"},"2":{"slot":2,"type":"STRING","value":"iropcodecontrolcategory"}}},"39":{"slot":39,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycontrolcategory1"},"2":{"slot":2,"type":"STRING","value":"departuredelaycontrolcategory1"}}},"40":{"slot":40,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycontrolcategory2"},"2":{"slot":2,"type":"STRING","value":"departuredelaycontrolcategory2"}}},"41":{"slot":41,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycontrolcategory3"},"2":{"slot":2,"type":"STRING","value":"departuredelaycontrolcategory3"}}},"42":{"slot":42,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycontrolcategory1"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycontrolcategory1"}}},"43":{"slot":43,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycontrolcategory2"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycontrolcategory2"}}},"44":{"slot":44,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"},"2":{"slot":2,"type":"STRING","value":"eventtype"}}},"45":{"slot":45,"values":{"1":{"slot":1,"type":"STRING","value":"etdutc"},"2":{"slot":2,"type":"STRING","value":"etdutc"}}},"46":{"slot":46,"values":{"1":{"slot":1,"type":"STRING","value":"etautc"},"2":{"slot":2,"type":"STRING","value":"etautc"}}},"47":{"slot":47,"values":{"1":{"slot":1,"type":"STRING","value":"stdutc"},"2":{"slot":2,"type":"STRING","value":"stdutc"}}},"48":{"slot":48,"values":{"1":{"slot":1,"type":"STRING","value":"stautc"},"2":{"slot":2,"type":"STRING","value":"stautc"}}},"49":{"slot":49,"values":{"1":{"slot":1,"type":"STRING","value":"standbyflag"},"2":{"slot":2,"type":"STRING","value":"standbyflag"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64807":{"id":64807,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":144,"y":384,"width":32,"height":32,"inputConnectorIDs":[64810],"outputConnectorIDs":[64809],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"add flightdetailhistory arrival/cancel"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/*****************************************************************************\n\tjoin the event records with the flight detail history table to get the\n    state of the flight at the time the event occurred\n    \n    join on the public irop and delay code tables to get the controllable category\n\n*****************************************************************************/\nSELECT \npfe.eventtype\n,pfe.eventdatetimeutc\n,pfe.departuredate\n,pfe.flightnumber\n,pfe.carriercode\n,pfe.departurestation\n,pfe.segmentid\n,pfe.legnumber\n,pfe.passengerid\n,ISNULL(pfe.standbyflag,0) AS standbyflag\n,fdh.std AS std\n,fdh.sta AS sta\n,fdh.etd AS etd\n,fdh.eta AS eta\n,fdh.stdutc AS stdutc\n,fdh.stautc AS stautc\n,fdh.etdutc AS etdutc\n,fdh.etautc AS etautc\n,fdh.outtime\n,fdh.offtime\n,fdh.ontime\n,fdh.intime\n,fdh.departureoveralldelaytime\n,fdh.departureoveralldelaycode \n,fdh.departureoveralldelaycontrollable \n,CASE WHEN ISNULL(depdelay.controllableflag,0) = 0 THEN 0 \n\t\tWHEN depdelay.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS departureoveralldelaycontrolcategory\n--,fdh.departureoveralldelaymaintenance     --01oct19 col removed\n,fdh.departuredelaycode1 \n,fdh.departuredelaytime1 \n,fdh.departuredelaycontrollable1 \n,CASE WHEN ISNULL(depdelay1.controllableflag,0) = 0 THEN 0 \n\t\tWHEN depdelay1.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS departuredelaycontrolcategory1\n,fdh.departuredelaycode2 \n,fdh.departuredelaytime2 \n,fdh.departuredelaycontrollable2 \n,CASE WHEN ISNULL(depdelay2.controllableflag,0) = 0 THEN 0 \n\t\tWHEN depdelay2.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS departuredelaycontrolcategory2\n,fdh.departuredelaycode3 \n,fdh.departuredelaytime3 \n,fdh.departuredelaycontrollable3\n,CASE WHEN ISNULL(depdelay3.controllableflag,0) = 0 THEN 0 \n\t\tWHEN depdelay3.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS departuredelaycontrolcategory3\n--,fdh.arrivalvsscheduled\n,fdh.arrivaloveralldelaytime\n,fdh.arrivaloveralldelaycode\n,fdh.arrivaloveralldelaycontrollable \n,CASE WHEN ISNULL(arrdelay.controllableflag,0) = 0 THEN 0 \n\t\tWHEN arrdelay.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS arrivaloveralldelaycontrolcategory\n,fdh.arrivaldelaycode1\n,fdh.arrivaldelaytime1\n,fdh.arrivaldelaycontrollable1\n,CASE WHEN ISNULL(arrdelay1.controllableflag,0) = 0 THEN 0 \n\t\tWHEN arrdelay1.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS arrivaldelaycontrolcategory1\n,fdh.arrivaldelaycode2\n,fdh.arrivaldelaytime2\n,fdh.arrivaldelaycontrollable2\n,CASE WHEN ISNULL(arrdelay2.controllableflag,0) = 0 THEN 0 \n\t\tWHEN arrdelay2.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS arrivaldelaycontrolcategory2\n,fdh.iropcode\n,CASE WHEN ic.controllableflag = 0 THEN 0 \n\t\tWHEN ic.controllablesafetyflag = 1  THEN 2 \n\t\tELSE 1 END AS iropcodecontrolcategory\t\n,(fdh.arrivaloveralldelaytime + fdh.arrivaldelaytime1 + fdh.arrivaldelaytime2) AS TotalArrivalDelayMinute\n\n,(CASE WHEN fdh.arrivaloveralldelaycontrollable = 1 THEN fdh.arrivaloveralldelaytime ELSE 0 END\n+ CASE WHEN fdh.arrivaldelaycontrollable1 = 1 THEN fdh.arrivaldelaytime1 ELSE 0 END\n+ CASE WHEN fdh.arrivaldelaycontrollable2 = 1 THEN fdh.arrivaldelaytime2 ELSE 0 END)\nAS ArrivalDelayControllableMinute\n,CAST(0 AS int) AS ArrivalDelayControllableSafetyMinute  /*will be updated after the controllable safety codes have been added */\n,(CASE WHEN fdh.arrivaloveralldelaycontrollable = 0 THEN fdh.arrivaloveralldelaytime ELSE 0 END\n+ CASE WHEN fdh.arrivaldelaycontrollable1 = 0 THEN fdh.arrivaldelaytime1 ELSE 0 END\n+ CASE WHEN fdh.arrivaldelaycontrollable2 = 0 THEN fdh.arrivaldelaytime2 ELSE 0 END)\nAS ArrivalDelayUnControllableMinute\n\n--,departurevsscheduled\n, CASE WHEN ISNULL(departureoveralldelaycode,'') <> '' THEN 1 ELSE 0 END AS flightdeparturedelayflag \n\nFROM $T{stage.pnrpassengerevent}  AS pfe\nINNER JOIN public.flightdetailhistory AS fdh\nON pfe.carriercode = fdh.carriercode\nAND pfe.flightnumber = fdh.flightnumber\nAND pfe.departuredate = fdh.flightdate\nAND pfe.departurestation = fdh.departurestation\nAND pfe.arrivalstation = fdh.arrivalstation\n--AND pfe.eventdatetimeutc BETWEEN cast(to_char(fdh.effectivedatetimeutc,'YYYY-MM-DD HH24:MI:SS') AS DATE) AND cast(to_char(fdh.expireddatetimeutc,'YYYY-MM-DD HH24:MI:SS') AS DATE)\nAND fdh.expireddatetimeutc = '9999-12-31 00:00:00'\nAND fdh.activeflag = 1\n--irop code\nLEFT JOIN public.iropcode AS ic\nON ic.iropcode = fdh.iropcode\n--departure\nLEFT JOIN public.delaycode AS depdelay\nON depdelay.delaycode = fdh.departureoveralldelaycode\nLEFT JOIN public.delaycode AS depdelay1\nON depdelay1.delaycode = fdh.departuredelaycode1\nLEFT JOIN public.delaycode AS depdelay2\nON depdelay2.delaycode = fdh.departuredelaycode2\nLEFT JOIN public.delaycode AS depdelay3\nON depdelay3.delaycode = fdh.departuredelaycode3\n--arrival\nLEFT JOIN public.delaycode AS arrdelay\nON arrdelay.delaycode = fdh.arrivaloveralldelaycode\nLEFT JOIN public.delaycode AS arrdelay1\nON arrdelay1.delaycode = fdh.arrivaldelaycode1\nLEFT JOIN public.delaycode AS arrdelay2\nON arrdelay2.delaycode = fdh.arrivaldelaycode2\nwhere pfe.carriercode = 'PD' \nAND pfe.eventtype in ('flightarrivalevent','flightcancelevent') \n--and pfe.passengerid='16498117' and fdh.flightnumber=463"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64808":{"id":64808,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":496,"y":384,"width":32,"height":32,"inputConnectorIDs":[64809],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"update events stage.pnrpassengereventcalc"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengereventcalc"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"},"2":{"slot":2,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"},"2":{"slot":2,"type":"STRING","value":"segmentid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"},"2":{"slot":2,"type":"STRING","value":"flightnumber"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"departuredate"},"2":{"slot":2,"type":"STRING","value":"departuredate"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"outtime"},"2":{"slot":2,"type":"STRING","value":"outtime"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"intime"},"2":{"slot":2,"type":"STRING","value":"intime"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaloveralldelaytime"},"2":{"slot":2,"type":"STRING","value":"arrivaloveralldelaytime"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaloveralldelaycode"},"2":{"slot":2,"type":"STRING","value":"arrivaloveralldelaycode"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaloveralldelaycontrollable"},"2":{"slot":2,"type":"STRING","value":"arrivaloveralldelaycontrollable"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycode1"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycode1"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaytime1"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaytime1"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycode2"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycode2"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaytime2"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaytime2"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"iropcode"},"2":{"slot":2,"type":"STRING","value":"iropcode"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"totalarrivaldelayminute"},"2":{"slot":2,"type":"STRING","value":"totalarrivaldelayminute"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycontrollablesafetyminute"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycontrollablesafetyminute"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelayuncontrollableminute"},"2":{"slot":2,"type":"STRING","value":"arrivaldelayuncontrollableminute"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycontrollableminute"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycontrollableminute"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"ontime"},"2":{"slot":2,"type":"STRING","value":"ontime"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"departureoveralldelaytime"},"2":{"slot":2,"type":"STRING","value":"departureoveralldelaytime"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"departureoveralldelaycode"},"2":{"slot":2,"type":"STRING","value":"departureoveralldelaycode"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"departureoveralldelaycontrollable"},"2":{"slot":2,"type":"STRING","value":"departureoveralldelaycontrollable"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycode1"},"2":{"slot":2,"type":"STRING","value":"departuredelaycode1"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaytime1"},"2":{"slot":2,"type":"STRING","value":"departuredelaytime1"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycode2"},"2":{"slot":2,"type":"STRING","value":"departuredelaycode2"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaytime2"},"2":{"slot":2,"type":"STRING","value":"departuredelaytime2"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycode3"},"2":{"slot":2,"type":"STRING","value":"departuredelaycode3"}}},"29":{"slot":29,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaytime3"},"2":{"slot":2,"type":"STRING","value":"departuredelaytime3"}}},"30":{"slot":30,"values":{"1":{"slot":1,"type":"STRING","value":"offtime"},"2":{"slot":2,"type":"STRING","value":"offtime"}}},"31":{"slot":31,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"},"2":{"slot":2,"type":"STRING","value":"carriercode"}}},"32":{"slot":32,"values":{"1":{"slot":1,"type":"STRING","value":"flightdeparturedelayflag"},"2":{"slot":2,"type":"STRING","value":"flightdeparturedelayflag"}}},"33":{"slot":33,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"},"2":{"slot":2,"type":"STRING","value":"legnumber"}}},"34":{"slot":34,"values":{"1":{"slot":1,"type":"STRING","value":"eta"},"2":{"slot":2,"type":"STRING","value":"eta"}}},"35":{"slot":35,"values":{"1":{"slot":1,"type":"STRING","value":"etd"},"2":{"slot":2,"type":"STRING","value":"etd"}}},"36":{"slot":36,"values":{"1":{"slot":1,"type":"STRING","value":"sta"},"2":{"slot":2,"type":"STRING","value":"sta"}}},"37":{"slot":37,"values":{"1":{"slot":1,"type":"STRING","value":"std"},"2":{"slot":2,"type":"STRING","value":"std"}}},"38":{"slot":38,"values":{"1":{"slot":1,"type":"STRING","value":"iropcodecontrolcategory"},"2":{"slot":2,"type":"STRING","value":"iropcodecontrolcategory"}}},"39":{"slot":39,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycontrolcategory1"},"2":{"slot":2,"type":"STRING","value":"departuredelaycontrolcategory1"}}},"40":{"slot":40,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycontrolcategory2"},"2":{"slot":2,"type":"STRING","value":"departuredelaycontrolcategory2"}}},"41":{"slot":41,"values":{"1":{"slot":1,"type":"STRING","value":"departuredelaycontrolcategory3"},"2":{"slot":2,"type":"STRING","value":"departuredelaycontrolcategory3"}}},"42":{"slot":42,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycontrolcategory1"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycontrolcategory1"}}},"43":{"slot":43,"values":{"1":{"slot":1,"type":"STRING","value":"arrivaldelaycontrolcategory2"},"2":{"slot":2,"type":"STRING","value":"arrivaldelaycontrolcategory2"}}},"44":{"slot":44,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"},"2":{"slot":2,"type":"STRING","value":"eventtype"}}},"45":{"slot":45,"values":{"1":{"slot":1,"type":"STRING","value":"etdutc"},"2":{"slot":2,"type":"STRING","value":"etdutc"}}},"46":{"slot":46,"values":{"1":{"slot":1,"type":"STRING","value":"etautc"},"2":{"slot":2,"type":"STRING","value":"etautc"}}},"47":{"slot":47,"values":{"1":{"slot":1,"type":"STRING","value":"stdutc"},"2":{"slot":2,"type":"STRING","value":"stdutc"}}},"48":{"slot":48,"values":{"1":{"slot":1,"type":"STRING","value":"stautc"},"2":{"slot":2,"type":"STRING","value":"stautc"}}},"49":{"slot":49,"values":{"1":{"slot":1,"type":"STRING","value":"standbyflag"},"2":{"slot":2,"type":"STRING","value":"standbyflag"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"64809":{"id":64809,"sourceID":64807,"targetID":64808},"64810":{"id":64810,"sourceID":64804,"targetID":64807},"64811":{"id":64811,"sourceID":64805,"targetID":64806},"64812":{"id":64812,"sourceID":64804,"targetID":64805}},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"64799":{"id":64799,"x":-215,"y":-77,"width":527,"height":129,"text":"Add the details of the flight, delays and times at the time the event was created.\n\nThe flightdetailhistory will only have flight information for PD flights when the flight has been added to the FMS(Sabre). Flights are added to the FMS between 4-6 weeks before the departure date. \n\nThe 2 process flows separates the differences between events required to have flight details at the time of the event and the latest details on the flight after the event occurred. \n\nonly look up PD flights\n\nupdate:2019-11-12","colour":"e6e63c"},"64800":{"id":64800,"x":57,"y":84,"width":174,"height":160,"text":"Get the flight details at the time of the event\n","colour":"e6e63c"},"64801":{"id":64801,"x":396,"y":72,"width":206,"height":174,"text":"**For testing purpose, we use update/insert\n We will change this to truncate when run in production\n**\n","colour":"e6e63c"},"64802":{"id":64802,"x":66,"y":283,"width":151,"height":177,"text":"Get the latest flight details for the event\n","colour":"e6e63c"},"64803":{"id":64803,"x":403,"y":285,"width":206,"height":174,"text":"**For testing purpose, we use update/insert\n We will change this to truncate when run in production\n**\n","colour":"e6e63c"}},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"PNR - Passenger Event Flight Details","description":"Add flight details to the passenger event records in the stage table","type":"TRANSFORMATION"}}