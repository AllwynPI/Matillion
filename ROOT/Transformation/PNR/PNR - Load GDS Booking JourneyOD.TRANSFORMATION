{"job":{"components":{"64784":{"id":64784,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":336,"y":304,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64786],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"bookings and passengers to process"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/****************************************\n\tidentify gds bookings\n    \n\tuse a common table expression to identify the key record values\n****************************************/\nSELECT \nDISTINCT\njourneydate.recordlocator AS pnr\n,journeydate.passengerid\n,journeydate.bookingcreatedutc\n,CAST(journeydate.departuredate AS date)  AS departuredate\n,journeydate.createdlocationcode\n,ppfirst.flightjourneynumber\n,ppfirst.departurestation AS firstdeparturestation\n,pplast.arrivalstation AS lastarrivalstation\n/* gds multiple journeys */\n,CASE WHEN journeydate.createdlocationcode = 'GDS' AND journeynumbercount > 1 \nAND ppfirst.departurestation <> pplast.arrivalstation THEN 1 \nELSE 0 END AS gdsmultiplebooking\n/* journey OD */\n,ppfirst.departurestation + pplast.arrivalstation AS journeyOD\n/* sameday roundtrip */\n,CASE WHEN ppfirst.departurestation = pplast.arrivalstation THEN 1 \nELSE 0 END AS samedayroundtrip\n\nFROM (\nSELECT \nrecordlocator\n,passengerid\n,departuredate\n,createdlocationcode\n,MIN(flightjourneynumber) AS firstflightjourneynumber\n,MAX(flightjourneynumber) AS lastflightjourneynumber \n,COUNT(DISTINCT journeynumber) AS journeynumbercount\n,MAX(bookingcreatedutc) AS bookingcreatedutc  \nFROM etl.pnrpassengerjourneyodgdsbooking\nGROUP BY \nrecordlocator,passengerid,departuredate,createdlocationcode) AS journeydate\nINNER JOIN etl.pnrpassengerjourneyodgdsbooking AS ppfirst\nON ppfirst.flightjourneynumber = journeydate.firstflightjourneynumber\nAND ppfirst.recordlocator = journeydate.recordlocator\nAND ppfirst.passengerid = journeydate.passengerid\nAND ppfirst.departuredate = journeydate.departuredate \nINNER JOIN etl.pnrpassengerjourneyodgdsbooking AS pplast\nON pplast.flightjourneynumber = journeydate.lastflightjourneynumber\nAND pplast.recordlocator = journeydate.recordlocator\nAND pplast.passengerid = journeydate.passengerid\nAND pplast.departuredate = journeydate.departuredate "}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64785":{"id":64785,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":560,"y":304,"width":32,"height":32,"inputConnectorIDs":[64786],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage.pnrpassengergdsbookingjourneyod"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengergdsbookingjourneyod"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnr"},"2":{"slot":2,"type":"STRING","value":"pnr"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"},"2":{"slot":2,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"departuredate"},"2":{"slot":2,"type":"STRING","value":"departuredate"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"createdlocationcode"},"2":{"slot":2,"type":"STRING","value":"createdlocationcode"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"flightjourneynumber"},"2":{"slot":2,"type":"STRING","value":"flightjourneynumber"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"firstdeparturestation"},"2":{"slot":2,"type":"STRING","value":"firstdeparturestation"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"lastarrivalstation"},"2":{"slot":2,"type":"STRING","value":"lastarrivalstation"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"gdsmultiplebooking"},"2":{"slot":2,"type":"STRING","value":"gdsmultiplebooking"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"journeyod"},"2":{"slot":2,"type":"STRING","value":"journeyod"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"samedayroundtrip"},"2":{"slot":2,"type":"STRING","value":"samedayroundtrip"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"bookingcreatedutc"},"2":{"slot":2,"type":"STRING","value":"bookingcreatedutc"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnr"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"64786":{"id":64786,"sourceID":64784,"targetID":64785}},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"64783":{"id":64783,"x":318,"y":169,"width":267,"height":66,"text":"Identify gds booking and journey od\n\nupdated: 2019-11-18","colour":"e6e63c"}},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"PNR - Load GDS Booking JourneyOD","description":"","type":"TRANSFORMATION"}}