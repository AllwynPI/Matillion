{"job":{"components":{"64795":{"id":64795,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":480,"y":208,"width":32,"height":32,"inputConnectorIDs":[64797],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"generatecalculationfields"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/*****************************************************************************************\n   calculate the journey sta for each passenger after a flight is added\n\t\n    assumes all the flight add and booked events are in the staging table \n*****************************************************************************************/    \n\nSELECT \npnr\n,journeynumber\n,eventdatetimeutc\n,eventname\n,journeysta\n/* compare event reasons with flight addes, may want to switch to comapare flight adds then event reasons */\n,CASE \n    /* CASE #1 */\n\tWHEN eventreason = 'MOVE' AND eventuser IN ('csr','callcenter') AND prevdrop_eta IS NULL AND prevadded_eta IS NULL THEN journeysta\n    WHEN eventreason = 'IROP' AND prevdrop_eta IS NULL AND prevadded_eta IS NULL THEN journeysta\n\t/* CASE #2 */\n\tWHEN eventreason = 'VOLF' AND eta > prevdrop_eta AND prevadded_eta IS NULL THEN eta\n\tWHEN eventreason = 'MOVE' AND eventuser IN ('customer') AND eta > prevdrop_eta AND prevadded_eta IS NULL THEN eta\n\tWHEN eventreason = '' AND eta > prevdrop_eta AND prevadded_eta IS NULL THEN eta\n\t\n\t/* CASE #3 */\n\tWHEN eventreason = 'VOLF' AND eta < prevdrop_eta AND prevadded_eventreason = 'MOVE' AND prevadded_eventuser IN ('csr','callcenter') THEN journeysta\n\tWHEN eventreason = 'VOLF' AND eta < prevdrop_eta AND prevadded_eventreason = 'IROP' THEN journeysta\n\tWHEN eventreason = 'MOVE' AND eventuser = 'customer' AND eta < prevdrop_eta AND prevadded_eventreason = 'MOVE' AND prevadded_eventuser IN ('csr','callcenter') THEN journeysta\n\tWHEN eventreason = 'MOVE' AND eventuser = 'customer' AND eta < prevdrop_eta AND prevadded_eventreason = 'IROP' THEN journeysta\n\tWHEN eventreason = '' AND eta < prevdrop_eta AND prevadded_eventreason = 'MOVE' AND prevadded_eventuser IN ('csr','callcenter') THEN journeysta\n\tWHEN eventreason = '' AND eta < prevdrop_eta AND prevadded_eventreason = 'IROP' THEN journeysta\n\t\n\t/* CASE #4 */\n\tWHEN eventreason = 'VOLF' AND eta < prevdrop_eta AND prevdrop_eta > prevdrop_sta AND journeydelay > 60 THEN journeysta\n\tWHEN eventreason = 'MOVE' AND eventuser = 'customer' AND eta < prevdrop_eta AND prevdrop_eta > prevdrop_sta AND journeydelay > 60 THEN journeysta\n\tWHEN eventreason = '' AND eta < prevdrop_eta AND prevdrop_eta > prevdrop_sta AND journeydelay > 60 THEN journeysta\n\t\n\t/* CASE #5 */\n\tWHEN eventreason = 'VOLF' AND eta < prevdrop_eta  THEN sta\n\tWHEN eventreason = 'MOVE' AND eventuser = 'customer' AND eta < prevdrop_eta THEN sta\n\tWHEN eventreason = '' AND eta < prevdrop_eta AND prevadded_eventreason = 'IROP' THEN sta\n\t\n\tELSE\n\t\tjourneysta\n\tEND AS newjourneysta\n,eventreason\n,eventuser\n,eta\n,prevdrop_eta\n,prevdrop_sta\n,prevadded_eventreason\n,prevadded_eventuser\nFROM \n(\n--L9WTYT\nSELECT \npfec.pnr\n,pfec.journeynumber\n--,pfec.departuredate\n,pfec.eventdatetimeutc\n--,bookingdatetimeutc\n--,pfec.flightnumber\n--,pfec.departurestation\n--,pfec.arrivalstation\n,pfec.eventuser\n,pfec.eventname\n,pfec.eta\n,pfec.sta\n,pfec.journeysta\n,pfec.journeydelay\n,pfec.eventreason\n,'prev flight drop' AS flightprev\n,prevdrop_ppec.eta  AS prevdrop_eta\n,prevdrop_ppec.sta  AS prevdrop_sta\n,prevdrop_ppec.eventreason AS prevdrop_eventreason\n,'prev flight add' AS flightadd\n,prevadded_ppec.flightnumber\n,prevadded_ppec.departurestation\n,prevadded_ppec.arrivalstation\n,prevadded_ppec.eta AS prevadded_eta\n,prevadded_ppec.eventreason AS prevadded_eventreason\n,prevadded_ppec.eventuser AS prevadded_eventuser\n,'info' AS info\n,pfec.passengerid\n--,pfec.segmentid\n--,pfec.legnumber\nFROM (\nSELECT \n\tpnr\n\t,journeynumber\n\t,eventname\n\t,eventuser\n\t,journeysta\n\t,CAST(75 AS int) AS journeydelay\n\t--,bookingdatetimeutc\n\t--,pfec.flightnumber\n\t--,departurestation\n\t--,arrivalstation\n\t,eta\n\t,sta\n\t,eventdatetimeutc\n\t,eventreason\n\t,passengerid\n   \t--,segmentid\n    --,pfec.legnumber\n\t--,pfec.departuredate\n\t/* Previous Dropped Flight Record */\n\t,(SELECT TOP 1 pnrpassengereventcalcid \n\t\tFROM stage.pnrpassengereventcalc AS fltdrop\n\t\tWHERE fltdrop.passengerid = pfec.passengerid\n\t\tAND fltdrop.journeynumber = pfec.journeynumber \n\t\tAND fltdrop.segmentnumber = pfec.segmentnumber\n\t\tAND fltdrop.eventname = 'FLIGHT DROPPED'\n\t\tAND fltdrop.eventdatetimeutc <= pfec.eventdatetimeutc\n\t\tORDER BY fltdrop.eventdatetimeutc DESC) AS previousdropped_pnrpassengereventcalcid\t\n\t/* Previous Flight Added Record */\n\t,(SELECT TOP 1 pnrpassengereventcalcid \n\t\tFROM stage.pnrpassengereventcalc AS fltdrop\n\t\tWHERE fltdrop.passengerid = pfec.passengerid\n\t\tAND fltdrop.journeynumber = pfec.journeynumber \n\t\tAND fltdrop.segmentnumber = pfec.segmentnumber\n\t\tAND fltdrop.eventname = 'FLIGHT ADDED'\n\t\tAND fltdrop.eventdatetimeutc < pfec.eventdatetimeutc\n\t\tORDER BY fltdrop.eventdatetimeutc DESC) AS previousadded_pnrpassengereventcalcid\t\t\nFROM $T{stage.pnrpassengereventcalc} AS pfec\n--FROM stage.pnrpassengereventcalc AS pfec\nWHERE pfec.pnr = 'V8UCHW' --'L9WTYT'\nAND pfec.eventname = 'FLIGHT ADDED'\n--AND POSITION('CHANGE' IN eventname) = 0\n) AS pfec\nLEFT JOIN stage.pnrpassengereventcalc AS prevdrop_ppec\nON pfec.previousdropped_pnrpassengereventcalcid\t= prevdrop_ppec.pnrpassengereventcalcid\nLEFT JOIN stage.pnrpassengereventcalc AS prevadded_ppec\nON pfec.previousadded_pnrpassengereventcalcid\t= prevadded_ppec.pnrpassengereventcalcid\n)\n--ORDER BY eventdatetimeutc, eventname DESC\nLIMIT 100"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64796":{"id":64796,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":272,"y":208,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64797],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage.pnrpassengereventcalc"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengereventcalc"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnr"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"journeynumber"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"stautc"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"sta"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"eventname"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"scheduledarrivalflightflag"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"segmentnumber"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"eventuser"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"journeysta"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"eta"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"eventreason"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"64797":{"id":64797,"sourceID":64796,"targetID":64795}},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"64793":{"id":64793,"x":226,"y":39,"width":523,"height":79,"text":"Update the Journey STA for passenger after a flight add event\n\nupdated: 2019-11-04","colour":"e6e63c"},"64794":{"id":64794,"x":408,"y":154,"width":157,"height":185,"text":"\n\n\n\n\n\n\nlook at STA based on pnr, passenger and journeynumber","colour":"e6e63c"}},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"PNR - Journey STA Calculation","description":"determines the journey sta after a flight add event","type":"TRANSFORMATION"}}