{"job":{"components":{"64744":{"id":64744,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-48,"y":176,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64747],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"flightevents"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT \nDISTINCT\nfeh.eventdatetimeutc\n\t,feh.eventname\n    ,feh.flighteventhistoryid\n\t,pph.passengerid\n    ,pph.journeynumber, pph.segmentid, pph.legnumber\n\t,pph.flightnumber, pph.departuredate, pph.departurestation\n\t,pph.segmentnumber\n\t,pph.bookingid\n\t,pph.bookingdatetimeutc\n\t,pph.pnr\n\t,pph.inventorylegid\n\t,pph.carriercode\n\t,pph.arrivalstation\n    ,pph.boardingsequence\n    ,pph.liftstatus\n\t,pph.assignedseat\n    ,pph.stdutc\n\t,pph.std\n\t,pph.sta\n\t,pph.stautc\n    ,ISNULL(pph.standbyflag,0) AS standbyflag\n    ,pph.productclasscode\nFROM public.pnrpassengerhistory AS pph\n\tINNER JOIN public.flighteventhistory AS feh\n\tON pph.flightnumber = feh.flightnumber\n\tAND pph.departuredate = feh.flightdate\n\tAND pph.departurestation = feh.departurestation\n\tAND pph.arrivalstation = feh.arrivalstation\nWHERE pph.eventname = 'BOARDED' AND pph.flownflightflag = 1\nAND feh.eventname = 'ARRIVAL' AND pph.standbyflag=0 AND pph.pnr IS NOT NULL\nAND NOT EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pp\n\t\t\t\tWHERE pp.eventname IN ('UNBOARDED') \n\t\t\t\tAND pp.pnr = pph.pnr\n\t\t\t\tAND pp.passengerid = pph.passengerid\n\t\t\t\tAND pp.flightnumber = feh.flightnumber\n                AND pp.journeynumber = pph.journeynumber\n\t\t\t\tAND pp.departuredate = feh.flightdate\n\t\t\t\tAND pp.departurestation = feh.departurestation\n\t\t\t\tAND pp.arrivalstation = feh.arrivalstation\n                AND pp.eventdatetimeutc > pph.eventdatetimeutc) \n/*load new events since last run or reload events based on pnrs in the list \nAND (feh.eventdatetimeutc >= '${maxflightarrivaleventdatetime}'\n\tOR EXISTS (SELECT 1 FROM stage.pnrpassengereventlist AS ppel\n\t\t\tWHERE pph.pnr = ppel.pnr)) */            \n-- check if the event is already in the public table\nAND NOT EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pp\n\t\t\t\tWHERE pp.eventname IN ('FLIGHT ARRIVAL') \n\t\t\t\tAND pp.pnr = pph.pnr\n\t\t\t\tAND pp.passengerid = pph.passengerid\n\t\t\t\tAND pp.flightnumber = pph.flightnumber\n                AND pp.journeynumber = pph.journeynumber\n\t\t\t\tAND pp.departuredate = pph.departuredate\n\t\t\t\tAND pp.departurestation = pph.departurestation\n\t\t\t\tAND pp.arrivalstation = pph.arrivalstation\n                AND pp.eventdatetimeutc = feh.eventdatetimeutc) \n/*AND EXISTS (SELECT 1 FROM stage.pnrpassengereventlist AS ppel\n\t\t\tWHERE pph.pnr = ppel.pnr)    */            \n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64745":{"id":64745,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":528,"y":176,"width":32,"height":32,"inputConnectorIDs":[64748],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage.pnrpassengerevent"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengerevent"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"},"2":{"slot":2,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"journeynumber"},"2":{"slot":2,"type":"STRING","value":"journeynumber"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"segmentnumber"},"2":{"slot":2,"type":"STRING","value":"segmentnumber"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"},"2":{"slot":2,"type":"STRING","value":"eventtype"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"bookingid"},"2":{"slot":2,"type":"STRING","value":"bookingid"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"bookingdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"bookingdatetimeutc"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"pnr"},"2":{"slot":2,"type":"STRING","value":"pnr"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"inventorylegid"},"2":{"slot":2,"type":"STRING","value":"inventorylegid"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"},"2":{"slot":2,"type":"STRING","value":"carriercode"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"},"2":{"slot":2,"type":"STRING","value":"flightnumber"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"departuredate"},"2":{"slot":2,"type":"STRING","value":"departuredate"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"},"2":{"slot":2,"type":"STRING","value":"departurestation"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"},"2":{"slot":2,"type":"STRING","value":"arrivalstation"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"createduserid"},"2":{"slot":2,"type":"STRING","value":"createduserid"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"modifieduserid"},"2":{"slot":2,"type":"STRING","value":"modifieduserid"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"},"2":{"slot":2,"type":"STRING","value":"legnumber"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"},"2":{"slot":2,"type":"STRING","value":"segmentid"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"flighteventhistoryid"},"2":{"slot":2,"type":"STRING","value":"eventsourceid"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"liftstatus"},"2":{"slot":2,"type":"STRING","value":"liftstatus"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"boardingsequence"},"2":{"slot":2,"type":"STRING","value":"boardingsequence"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"sta"},"2":{"slot":2,"type":"STRING","value":"sta"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"stautc"},"2":{"slot":2,"type":"STRING","value":"stautc"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"std"},"2":{"slot":2,"type":"STRING","value":"std"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"stdutc"},"2":{"slot":2,"type":"STRING","value":"stdutc"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"assignedseat"},"2":{"slot":2,"type":"STRING","value":"unitdesignator"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"standbyflag"},"2":{"slot":2,"type":"STRING","value":"standbyflag"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"productclasscode"},"2":{"slot":2,"type":"STRING","value":"productclasscode"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Delete/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64746":{"id":64746,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":256,"y":176,"width":32,"height":32,"inputConnectorIDs":[64747],"outputConnectorIDs":[64748],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"flightevents_eventflag"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT \n'flightarrivalevent' AS eventtype\n,CAST(1 AS int) AS createduserid --default user id= SystemMaster\n,CAST(1 AS int) AS modifieduserid --default user id= SystemMaster\n,*\nFROM $T{flightevents}"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"64747":{"id":64747,"sourceID":64744,"targetID":64746},"64748":{"id":64748,"sourceID":64746,"targetID":64745}},"canUndo":true,"undoCommand":"Move Components","undoCreated":1576861576680,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"64740":{"id":64740,"x":-144,"y":-92,"width":538,"height":138,"text":"add new flight ops arrivals to the pnr history \n\nonly 1 flight arrival event can exist for a passengerid, segmentid, legnumber\n\nadd new flights since last run and reload events based on the pnrs in the stage table\n\nthe records in the stage.pnrpassengerevent records are deleted and reloaded\n\nUpdate:2019-11-28","colour":"e6e63c"},"64741":{"id":64741,"x":-136,"y":82,"width":229,"height":143,"text":"flight ops event data\n","colour":"e6e63c"},"64742":{"id":64742,"x":429,"y":72,"width":206,"height":174,"text":"**For testing purpose, we use update/insert\n We will change this to truncate when run in production\n**\n","colour":"e6e63c"},"64743":{"id":64743,"x":187,"y":74,"width":137,"height":176,"text":"add indicators to identify the event of the record","colour":"e6e63c"}},"noteConnectors":{},"variables":{"maxflightarrivaleventdatetime":{"definition":{"name":"maxflightarrivaleventdatetime","type":"DATETIME","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"2019-11-13"}},"grids":{}},"info":{"name":"PNR - Ops Flight Arrival Event","description":"extract the flight ops events","type":"TRANSFORMATION"}}