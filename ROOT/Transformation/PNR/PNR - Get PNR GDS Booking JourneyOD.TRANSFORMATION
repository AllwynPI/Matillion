{"job":{"components":{"64852":{"id":64852,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":336,"y":304,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64854],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"bookings and passengers to process"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/*********************************************************************\n\tretrieve PNR data to determine gds bookings and journey OD\n**********************************************************************/\nSELECT * \nFROM (\nSELECT  \n\tb.recordlocator, b.bookingid,bp.passengerid, pjsv.segmentid, pjsv.versionstartutc\n   ,pjsv.journeynumber, pjsv.segmentnumber, pjlv.legnumber,b.createdutc AS bookingcreatedutc\n\t, pjsv.departuredate, pjsv.departurestation, pjsv.arrivalstation \n\t/* return the earliest datetime of the passenger segment */\n\t,(SELECT MIN(versionstartutc) FROM ods.passengerjourneysegmentversion\n\t\tWHERE passengerid = pjsv.passengerid AND segmentid = pjsv.segmentid) AS segmentminstartdatetimeutc\n\t/* returen the arrival station of the previous segment */\t\n\t,lag(pjsv.arrivalstation) over(partition by b.bookingid, bp.passengerid order by il.std asc) prev_arrivalstation\n\t,pjlv.inventorylegid\n\t,pjlv.versionstartutc AS pjlvversionstartutc\n\t,il.std \n\t/* return the earliest datetime when the flight was added on the segment */\n\t,(SELECT MIN(versionstartutc) FROM ods.passengerjourneylegversion\n\t\tWHERE passengerid = pjsv.passengerid AND segmentid = pjsv.segmentid) AS legminstartdatetimeutc\n\t,b.createdlocationcode\t\n\t,CAST(pjsv.journeynumber AS varchar(1)) + CAST(pjsv.segmentnumber AS varchar(1)) + CAST(pjlv.legnumber AS varchar(1)) AS flightjourneynumber\n\nFROM ods.bookingpassenger AS bp\n\t\tINNER JOIN ods.passengerjourneysegmentversion AS pjsv\n\t\tON bp.passengerid = pjsv.passengerid\n\t\tINNER JOIN ods.booking AS b\n\t\tON bp.bookingid = b.bookingid\n\t\tINNER JOIN ods.passengerjourneylegversion AS pjlv\n\t\tON bp.passengerid = pjlv.passengerid\n\t\tAND pjsv.segmentid = pjlv.segmentid\n\t\tINNER JOIN ods.inventoryleg AS il\n\t\tON il.inventorylegid = pjlv.inventorylegid\n\n    WHERE b.createdutc >= '${maxcreatedutc}'\n  /*\n    WHERE EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pph\n                  \tWHERE pph.pnr = b.recordlocator)\n    AND NOT EXISTS (SELECT 1 FROM stage.pnrpassengergdsbookingjourneyod AS gbj\n    \t\t\t\tWHERE gbj.pnr = b.recordlocator)\n  */\n)\n/* return only the first record occurance of the flights when the booking was made */\nWHERE bookingcreatedutc = versionstartutc\nAND versionstartutc = segmentminstartdatetimeutc\nAND legminstartdatetimeutc = pjlvversionstartutc"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64853":{"id":64853,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":335239555,"x":544,"y":304,"width":32,"height":32,"inputConnectorIDs":[64854],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"etl.pnrpassengerjourneyodgdsbooking"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengerjourneyodgdsbooking"}}}},"visible":true},"3":{"slot":3,"name":"Table Sort Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"recordlocator"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"departuredate"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"createdlocationcode"}}}},"visible":true},"4":{"slot":4,"name":"Table Distribution Style","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Even"}}}},"visible":true},"5":{"slot":5,"name":"Table Distribution Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":null}}}},"visible":false},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"etl"}}}},"visible":true},"7":{"slot":7,"name":"Sort Key Options","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Compound"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"64854":{"id":64854,"sourceID":64852,"targetID":64853}},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"64851":{"id":64851,"x":310,"y":171,"width":267,"height":66,"text":"Identify pnrs to flag gds bookings and journey od\n\nupdated: 2019-11-19","colour":"e6e63c"}},"noteConnectors":{},"variables":{"maxcreatedutc":{"definition":{"name":"maxcreatedutc","type":"DATETIME","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"2019-11-01"}},"grids":{}},"info":{"name":"PNR - Get PNR GDS Booking JourneyOD","description":"","type":"TRANSFORMATION"}}