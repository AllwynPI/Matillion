{"job":{"components":{"64691":{"id":64691,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":368,"y":304,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64693],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"bookings and passengers to process"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT DISTINCT b.recordlocator AS pnr, bp.bookingid, bp.passengerid\n\t, b.createdutc AS bookingcreateddatetimeutc, b.modifiedutc AS bookingmodifieddatetimeutc\n\t,  b.status AS bookingstatus\n\t,pbp.parentbookingid AS bookingparentid\n    ,CASE WHEN pbp.parentbookingid IS NOT NULL THEN 1 ELSE 0 END AS parentpnrflag\n\t,pbp.parentpnr AS parentpnr\n\t,pbp.parentbookingcreateddatetimeutc AS parentbookingdatetimeutc\nFROM  ods.booking as B\n\tINNER JOIN ods.BookingPassenger AS bp \n\tON b.BookingID = bp.BookingID \n    --INNER JOIN stage.pnrbookingparent AS pbp\n    LEFT JOIN stage.pnrbookingparent AS pbp\n\tON b.bookingid = pbp.bookingid\nWhere  b.recordlocator in ('Q76KFZ')\n\n/*WHERE EXISTS (SELECT 1 FROM stage.double_bookedevent AS pm\n\t\t\tWHERE  pm.pnr = b.recordlocator )*/\n\n/*\nWHERE EXISTS (SELECT 1 FROM stage.cleanorphan_records_2 AS pph\n\t\t\tWHERE  pph.pnr = b.recordlocator \n             AND pph.passengerid = bp.passengerid)\n*/            \n--david test pnr 2019-12-07 reload missing pnrs test\n--WHERE b.recordlocator in ('I8ZHKW')\n \n--WHERE EXISTS (SELECT 1 FROM stage.missing_add_events AS p\n--     WHERE p.pnr = b.recordlocator )\n\n/* load all pnrs with missing arrival events */\n--WHERE b.recordlocator IN ('KY4M7A','F386GV')\n/**********************************\n\tload historical PNRs for a departure range not already in the pnr history table\n**********************************/\n--WHERE\n/************************* these pnrs already exist but are missing arrival event.\nNOT EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pph\n\t\t\tWHERE  pph.pnr = b.recordlocator)            \nAND \n*****************************/\n--EXISTS (SELECT 1 FROM stage.reload_nullsegmentsta20191127 AS phd\n--            WHERE phd.pnr = b.recordlocator)\n\n--EXISTS (SELECT 1 FROM stage.pnrhistorydeparture20182019 AS phd\n--            WHERE phd.pnr = b.recordlocator\n--            AND phd.departuredate BETWEEN '2018-11-01' AND '2019-12-01')\n\n\n            \n/*EXISTS (SELECT 1 FROM ods.booking AS bb\n\t\t\t\tWHERE bb.createdutc BETWEEN '2019-06-26' AND '2019-06-27'\n\t\t\t\tAND bb.recordlocator = b.recordlocator)\nOR EXISTS (SELECT 1 FROM ods.booking AS bb\n\t\t\t\tWHERE bb.createdutc BETWEEN '2018-10-07' AND '2018-10-08'\n\t\t\t\tAND bb.recordlocator = b.recordlocator)             \n*/\n/****************Added by david to fix NULL stautc, etd, etas********************************/\n--INNER JOIN sandbox.dwtest_pnrs20191118 t\n--on b.recordlocator = t.pnr\n/********************************************************************************************/\n\n--WHERE EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pph\n--\t\t\t\tWHERE pph.eventname = 'SEGMENT DROPPED' \n--\t\t\t\tAND pph.pnr = b.recordlocator)\n--WHERE b.recordlocator = 'TCNS3X'\n--WHERE EXISTS (SELECT 1 FROM stage.wrong_carrier_info_pnr AS pph \n--\t\t\t\tWHERE pph.pnr = b.recordlocator)\n\n--WHERE EXISTS (select 1\n--\t\t\tfrom public.pnrpassengerhistory AS p\n--\t\t\twhere p.standbyflag is null\n--            AND p.pnr = b.recordlocator)\n            \n            \n            \n--WHERE b.recordlocator = 'Y9NHHG'\n --add a test pnr to reprocess\n/*WHERE EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pph \n\t\t\t\tWHERE pph.pnr = b.recordlocator AND pph.pnr = 'U4FQKV') --'DCKHFH') --'X6JPKP')\n*/\n\n/* add pnrs with unknown events to reprocess them \nWHERE EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pph \n\t\t\t\tWHERE pph.eventname = 'UNKNOWN'\n \t\t\tAND EXISTS (SELECT 1 FROM ods.booking AS b\n \t\t\t\t\t\tWHERE b.bookingid = pph.bookingid\n\t\t\t\t\t\tAND b.bookingparentid > 0)\n             AND pph.pnr =b.recordlocator  )\n\n*/\n/*\n--updating unknown events\nWHERE EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pph \n\t\t\t\tWHERE pph.eventname = 'UNKNOWN'\n\t\t\t\tAND pph.assignedseat <> ''\n\t\t\t\tAND pph.bookingdatetimeutc > '2019-07-01'\n\t\t\t\tAND pph.pnr = b.recordlocator)\n*/"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64692":{"id":64692,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":576,"y":304,"width":32,"height":32,"inputConnectorIDs":[64693],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage.pnrpassengereventlist"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengereventlist"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnr"},"2":{"slot":2,"type":"STRING","value":"pnr"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"bookingid"},"2":{"slot":2,"type":"STRING","value":"bookingid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"},"2":{"slot":2,"type":"STRING","value":"passengerid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"bookingcreateddatetimeutc"},"2":{"slot":2,"type":"STRING","value":"bookingcreateddatetimeutc"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"bookingmodifieddatetimeutc"},"2":{"slot":2,"type":"STRING","value":"bookingmodifieddatetimeutc"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"bookingstatus"},"2":{"slot":2,"type":"STRING","value":"bookingstatus"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"parentpnrflag"},"2":{"slot":2,"type":"STRING","value":"parentpnrflag"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"bookingparentid"},"2":{"slot":2,"type":"STRING","value":"bookingparentid"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"parentpnr"},"2":{"slot":2,"type":"STRING","value":"parentpnr"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"parentbookingdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"parentbookingdatetimeutc"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate"}}}},"visible":true},"6":{"slot":6,"name":"Automatic Compression","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"64693":{"id":64693,"sourceID":64691,"targetID":64692}},"canUndo":true,"undoCommand":"Set Parameter","undoCreated":1578521162656,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"64690":{"id":64690,"x":347,"y":157,"width":267,"height":66,"text":"manual load records that have been created or updated since the last run\n\nupdated: 2019-11-25","colour":"e6e63c"}},"noteConnectors":{},"variables":{"maxeventdate":{"definition":{"name":"maxeventdate","type":"DATETIME","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"1990-01-01 00:00:00"}},"grids":{}},"info":{"name":"PNR - Load Passenger List Manual Load","description":"","type":"TRANSFORMATION"}}