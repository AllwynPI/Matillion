{"job":{"components":{"64734":{"id":64734,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-48,"y":176,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64738],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"flightevents"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/**********************************************************************************************\n\tcreate a cancel event for a passenger journey when the passenger has been added \n    to the flight by a booked event or a flight add event\n    \n    do not add the cancel event if there is a dropped event more than 10 minutes prior to the cancel event\n    \n    when there are multiple drop events compare each to determine which if any will fit with the cance event\n    \n\tadd a 10 minute buffer for cancel events that happen after the passenger was dropped from the flight\n***********************************************************************************************/\nSELECT \nDISTINCT\n'flightcancelevent' AS eventtype\n,CAST(1 AS int) AS createduserid --default user id= SystemMaster\n,CAST(1 AS int) AS modifieduserid --default user id= SystemMaster\n,feh.eventdatetimeutc\n\t,feh.eventname\n    ,feh.flighteventhistoryid\n\t,pph.passengerid, pph.journeynumber, pph.segmentid, pph.legnumber\n\t,pph.flightnumber, pph.departuredate, pph.departurestation\n\t,pph.segmentnumber\n\t,pph.bookingid\n\t,pph.bookingdatetimeutc\n\t,pph.pnr\n\t,pph.inventorylegid\n\t,pph.carriercode\n\t,pph.arrivalstation\n    ,pph.boardingsequence\n    ,pph.liftstatus\n\t,pph.assignedseat\n    ,pph.stdutc\n\t,pph.std\n\t,pph.sta\n\t,pph.stautc\n    ,ISNULL(pph.standbyflag,0) AS standbyflag\n    ,pph.productclasscode\n    /* calculate the difference between the cancel and dropped events if they exists */\n    ,DATEDIFF(min,feh.eventdatetimeutc,ISNULL(drp.eventdatetimeutc,feh.eventdatetimeutc) ) AS canceldropeventdifference\nFROM public.pnrpassengerhistory AS pph\n\tINNER JOIN public.flighteventhistory AS feh\n\tON pph.flightnumber = feh.flightnumber\n\tAND pph.departuredate = feh.flightdate\n\tAND pph.departurestation = feh.departurestation\n\tAND pph.arrivalstation = feh.arrivalstation\n\t/*check for any previous flight drop events */\n\tLEFT JOIN public.pnrpassengerhistory AS drp\n  \tON drp.eventname IN ('FLIGHT DROPPED') \n\tAND drp.pnr = pph.pnr\n\tAND drp.passengerid = pph.passengerid\n\tAND drp.flightnumber = feh.flightnumber\n    AND drp.journeynumber = pph.journeynumber\n\tAND drp.departuredate = feh.flightdate\n\tAND drp.departurestation = feh.departurestation\n\tAND drp.arrivalstation = feh.arrivalstation\nWHERE pph.eventname IN ('BOOKED','FLIGHT ADDED') AND pph.pnr IS NOT NULL\nAND feh.eventname = 'CANCEL FLIGHT'\n/*\nAND NOT EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pp\n\t\t\t\tWHERE pp.eventname IN ('FLIGHT DROPPED') \n\t\t\t\tAND pp.pnr = pph.pnr\n\t\t\t\tAND pp.passengerid = pph.passengerid\n\t\t\t\tAND pp.flightnumber = feh.flightnumber\n                AND pp.journeynumber = pph.journeynumber\n\t\t\t\tAND pp.departuredate = feh.flightdate\n\t\t\t\tAND pp.departurestation = feh.departurestation\n\t\t\t\tAND pp.arrivalstation = feh.arrivalstation\n\t\t\t\tAND pp.eventdatetimeutc < DATEADD(min, -10, feh.eventdatetimeutc))      \n*/\n/*\nAND (feh.eventdatetimeutc >= '${maxflightcanceleventdatetime}'\n\tOR EXISTS (SELECT 1 FROM stage.pnrpassengereventlist AS ppel\n\tWHERE pph.pnr = ppel.pnr))\n*/\n-- check if the event is already in the public table \nAND NOT EXISTS (SELECT 1 FROM public.pnrpassengerhistory AS pp\n\t\t\t\tWHERE pp.eventname IN ('FLIGHT CANCEL') \n\t\t\t\tAND pp.pnr = pph.pnr\n\t\t\t\tAND pp.passengerid = pph.passengerid\n\t\t\t\tAND pp.flightnumber = pph.flightnumber\n                AND pp.journeynumber = pph.journeynumber\n\t\t\t\tAND pp.departuredate = pph.departuredate\n\t\t\t\tAND pp.departurestation = pph.departurestation\n\t\t\t\tAND pp.arrivalstation = pph.arrivalstation\n                AND pp.eventdatetimeutc = feh.eventdatetimeutc) \n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64735":{"id":64735,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":352,"y":176,"width":32,"height":32,"inputConnectorIDs":[64737],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage.pnrpassengerevent"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengerevent"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"},"2":{"slot":2,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"journeynumber"},"2":{"slot":2,"type":"STRING","value":"journeynumber"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"segmentnumber"},"2":{"slot":2,"type":"STRING","value":"segmentnumber"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"},"2":{"slot":2,"type":"STRING","value":"eventtype"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"bookingid"},"2":{"slot":2,"type":"STRING","value":"bookingid"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"bookingdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"bookingdatetimeutc"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"pnr"},"2":{"slot":2,"type":"STRING","value":"pnr"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"inventorylegid"},"2":{"slot":2,"type":"STRING","value":"inventorylegid"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"},"2":{"slot":2,"type":"STRING","value":"carriercode"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"},"2":{"slot":2,"type":"STRING","value":"flightnumber"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"departuredate"},"2":{"slot":2,"type":"STRING","value":"departuredate"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"},"2":{"slot":2,"type":"STRING","value":"departurestation"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"},"2":{"slot":2,"type":"STRING","value":"arrivalstation"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"createduserid"},"2":{"slot":2,"type":"STRING","value":"createduserid"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"modifieduserid"},"2":{"slot":2,"type":"STRING","value":"modifieduserid"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"},"2":{"slot":2,"type":"STRING","value":"legnumber"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"},"2":{"slot":2,"type":"STRING","value":"segmentid"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"flighteventhistoryid"},"2":{"slot":2,"type":"STRING","value":"eventsourceid"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"liftstatus"},"2":{"slot":2,"type":"STRING","value":"liftstatus"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"boardingsequence"},"2":{"slot":2,"type":"STRING","value":"boardingsequence"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"sta"},"2":{"slot":2,"type":"STRING","value":"sta"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"stautc"},"2":{"slot":2,"type":"STRING","value":"stautc"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"std"},"2":{"slot":2,"type":"STRING","value":"std"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"stdutc"},"2":{"slot":2,"type":"STRING","value":"stdutc"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"assignedseat"},"2":{"slot":2,"type":"STRING","value":"unitdesignator"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"standbyflag"},"2":{"slot":2,"type":"STRING","value":"standbyflag"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"productclasscode"},"2":{"slot":2,"type":"STRING","value":"productclasscode"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Delete/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64736":{"id":64736,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":160,"y":176,"width":32,"height":32,"inputConnectorIDs":[64738],"outputConnectorIDs":[64737],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"format filter"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/*******************************************************************************\n\n\tfilter out any cancel events with drop events 10 minute before the cancel event\n\n*******************************************************************************/\nSELECT\n*\nFROM $T{flightevents}\nWHERE canceldropeventdifference >=-10 /* minutes */"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"64737":{"id":64737,"sourceID":64736,"targetID":64735},"64738":{"id":64738,"sourceID":64734,"targetID":64736}},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"64731":{"id":64731,"x":-139,"y":-86,"width":577,"height":109,"text":"add new flight cancel ops to the pnr history \n\nuses the latest max cancel eventdatetime to identify new cancel events\n\nadd new cancel events since last run and reload events based on the pnrs in the stage table\n\nUpdate:2019-12-17","colour":"e6e63c"},"64732":{"id":64732,"x":-136,"y":82,"width":229,"height":143,"text":"flight ops event data\n\nadd indicators to identify the event of the record","colour":"e6e63c"},"64733":{"id":64733,"x":246,"y":87,"width":239,"height":139,"text":"**For testing purpose, we use update/insert\n We will change this to truncate when run in production\n**\n","colour":"e6e63c"}},"noteConnectors":{},"variables":{"maxflightcanceleventdatetime":{"definition":{"name":"maxflightcanceleventdatetime","type":"DATETIME","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"2019-11-13"}},"grids":{}},"info":{"name":"PNR - Ops Flight Cancel Events","description":"extract the flight ops events","type":"TRANSFORMATION"}}