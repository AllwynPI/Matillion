{"job":{"components":{"64684":{"id":64684,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":464,"y":208,"width":32,"height":32,"inputConnectorIDs":[64688],"outputConnectorIDs":[64687],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"generatecalculationfields"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT \n\t/*--scheduled.stautc AS scheduledstautc  Updated 2019-11-01 */\n     CASE WHEN pfe.originaldeparturedate = CAST(CONVERT_TIMEZONE('UTC',awstimezone, CAST(pfe.bookingdatetimeutc AS timestamp) ) AS date) \n   \t\tTHEN scheduledsameday.stautc ELSE scheduled.stautc \tEND AS scheduledstautc\n\t,actual.stautc AS actualstautc\n\t\n    ,CASE WHEN pfe.originaldeparturedate = CAST(CONVERT_TIMEZONE('UTC',awstimezone, CAST(pfe.bookingdatetimeutc AS timestamp) ) AS date)\n\t\t\tTHEN datediff(min, scheduledsameday.stautc, actual.stautc)\n\t\t\tELSE datediff(min, scheduled.stautc, actual.stautc)\n\t\t\tEND AS scheduleactualstaminutedifference\n\n    /* additional condition to check for sameday bookings to the case statement */\n    ,CASE WHEN pfe.originaldeparturedate = CAST(CONVERT_TIMEZONE('UTC',awstimezone, CAST(pfe.bookingdatetimeutc AS timestamp) ) AS date)\n\t\t THEN (CASE WHEN pfe.flightnumber = ISNULL(TRIM(scheduledsameday.flightnumber),'') THEN 1 ELSE 0 END) \n\t\tELSE (CASE WHEN pfe.flightnumber = ISNULL(TRIM(scheduled.flightnumber),'') THEN 1 ELSE 0 END)  \n\t\t END AS scheduledarrivalflightflag\n   ,CASE WHEN pfe.flightnumber = ISNULL(TRIM(actual.flightnumber),'') THEN 1 ELSE 0 END actualarrivalflightflag\n   ,pfe.eventdatetimeutc\n\n   ,CASE WHEN pfe.originaldeparturedate =  CAST(CONVERT_TIMEZONE('UTC',awstimezone, CAST(pfe.bookingdatetimeutc AS timestamp) ) AS date) \n   \t\tTHEN scheduledarrivalinventorylegid_sameday ELSE scheduledarrivalinventorylegid END AS scheduledarrivalinventorylegid\n\n   ,pfe.actualarrivalinventorylegid\n   ,pfe.passengerid\n   ,pfe.segmentid\n   ,pfe.legnumber\n\nFROM (\nSELECT \n\tpnr\n\t,originaldeparturedate\n\t,bookingdatetimeutc\n\t,flightnumber\n\t,eventdatetimeutc\n\t,passengerid\n   \t,segmentid\n    ,legnumber\n\t,pfe.departuredate\n\t,awstimezone\n\t/* ################# get scheduled and arrival destination flights ########*/\t\n\t/*get the final scheduled flight # for each journey prior to the departure date\n\tuse the version tables as the flights could have changed on the day of departure*/\n\n  ,(SELECT TOP 1 pjlv1.inventorylegid\n\tFROM ods.passengerjourneysegmentversion AS pjsv\n\t\t\tINNER JOIN ods.passengerjourneylegversion AS pjlv1\n\t\t\tON pjsv.segmentid = pjlv1.segmentid AND pjsv.passengerid = pjlv1.passengerid\n\t        INNER JOIN public.airport AS a\n            ON pjsv.departurestation = a.airportcode\t\t\n\tWHERE pjsv.passengerid = pfe.passengerid \n\tAND pjsv.journeynumber = pfe.journeynumber \n\tAND pjsv.departuredate = CAST(pfe.departuredate AS date) \n\t-- Converting local time to UTC\n\tAND pjsv.versionstartutc < CONVERT_TIMEZONE(a.awstimezone,'UTC', pfe.originaldeparturedate)   \n\n    AND EXISTS (SELECT 1 FROM ods.inventorylegversion AS ilv\n\t\t\t\tWHERE ilv.carriercode = 'PD'\n\t\t\t\tAND ilv.inventorylegid = pjlv1.inventorylegid)\n    ORDER BY pjsv.segmentnumber DESC, pjlv1.legnumber DESC, pjsv.versionendutc\n   ) AS scheduledarrivalinventorylegid\n\t\n  \t/* ################# get scheduled flight for same day bookings ########*/\t\n\t\n    ,(SELECT TOP 1 pjlv1.inventorylegid\n\tFROM ods.passengerjourneysegmentversion AS pjsv\n\t\t\tINNER JOIN ods.passengerjourneylegversion AS pjlv1\n\t\t\tON pjsv.segmentid = pjlv1.segmentid AND pjsv.passengerid = pjlv1.passengerid\n\t\t\tINNER JOIN public.airport AS a\n            ON pjsv.departurestation = a.airportcode\t\n\tWHERE pjsv.passengerid = pfe.passengerid \n\tAND pjsv.journeynumber = pfe.journeynumber \n\tAND pjsv.departuredate = CAST(pfe.departuredate AS date) \n\t-- Converting booking time into UTC\n    AND pjsv.departuredate = CAST(CONVERT_TIMEZONE('UTC',a.awstimezone, CAST(pfe.bookingdatetimeutc AS timestamp) ) AS date)  \n    AND EXISTS (SELECT 1 FROM ods.inventorylegversion AS ilv\n\t\t\t\tWHERE ilv.carriercode = 'PD'\n\t\t\t\tAND ilv.inventorylegid = pjlv1.inventorylegid)\n  \t\t\t\t ORDER BY pjsv.segmentnumber DESC, pjlv1.legnumber DESC, pjsv.versionendutc\n     \t\t\t) AS scheduledarrivalinventorylegid_sameday\n  \n\t/*get the final actual flight # for each journey for the departure date\n\tuse the actual tables to get the current flight*/\n\t,(SELECT TOP 1 il.inventorylegid\n\t\tFROM ods.passengerjourneysegment AS pjsv\n\t\t\t\tINNER JOIN ods.passengerjourneyleg AS pjlv1\n\t\t\t\tON pjsv.segmentid = pjlv1.segmentid AND pjsv.passengerid = pjlv1.passengerid\n\t\t\t\tINNER JOIN ods.inventoryleg AS il\n\t\t\t\tON pjlv1.inventorylegid = il.inventorylegid\n\t\tWHERE pjsv.passengerid = pfe.passengerid \n\t\tAND pjsv.journeynumber = pfe.journeynumber \n\t\tAND pjsv.departuredate = CAST(pfe.departuredate AS date)\n        AND EXISTS (SELECT 1 FROM ods.inventorylegversion AS ilv\n\t\t\t\tWHERE ilv.carriercode = 'PD'\n\t\t\t\tAND ilv.inventorylegid = pjlv1.inventorylegid)\n\t\tORDER BY pjsv.segmentnumber DESC, pjlv1.legnumber DESC) AS actualarrivalinventorylegid\nFROM stage.pnrpassengerevent AS pfe\nINNER JOIN public.airport AS a\nON pfe.departurestation = a.airportcode\n/* all add records from the staging event table */\nWHERE  pfe.eventtype = 'pjlvadd'\nAND EXISTS (SELECT 1 FROM stage.pnrpassengereventlist AS ppel\n\t\t\t\tWHERE pfe.pnr = ppel.pnr\n           \t\tAND pfe.passengerid = ppel.passengerid)\n) AS pfe\nLEFT JOIN ods.inventorylegversion AS scheduled\n  ON scheduled.inventorylegid = pfe.scheduledarrivalinventorylegid \n  AND pfe.eventdatetimeutc >= scheduled.versionstartutc\n  AND pfe.eventdatetimeutc < scheduled.versionendutc\nLEFT JOIN ods.inventoryleg AS actual\n  ON actual.inventorylegid = pfe.actualarrivalinventorylegid\nLEFT JOIN ods.inventorylegversion AS scheduledsameday \n  ON scheduledsameday.inventorylegid = pfe.scheduledarrivalinventorylegid_sameday \nAND pfe.eventdatetimeutc >= scheduledsameday.versionstartutc AND \n    pfe.eventdatetimeutc < scheduledsameday.versionendutc\n    \n -- Test pfe.passengerid='16834186'"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64685":{"id":64685,"inputCardinality":"ZERO","outputCardinality":"MANY","implementationID":1354890871,"x":208,"y":208,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[64688],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengerevent"}}}},"visible":true},"2":{"slot":2,"name":"Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengerevent"}}}},"visible":true},"3":{"slot":3,"name":"Column Names","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"pnr"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"inventorylegid"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"boardingsequence"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"createduserid"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"modifieduserid"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"journeynumber"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"segmentnumber"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"liftstatus"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"prev_liftstatus"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"unitdesignator"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"prev_unitdesignator"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"departuredate"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"stdutc"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"std"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"bookingdatetimeutc"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"bookingid"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"segmentminstartdatetimeutc"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"segmentmaxstartdatetimeutc"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"segmentminenddatetimeutc"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"segmentmaxenddatetimeutc"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"legminstartdatetimeutc"}}},"29":{"slot":29,"values":{"1":{"slot":1,"type":"STRING","value":"legmaxstartdatetimeutc"}}},"30":{"slot":30,"values":{"1":{"slot":1,"type":"STRING","value":"legmaxenddatetimeutc"}}},"31":{"slot":31,"values":{"1":{"slot":1,"type":"STRING","value":"segmentchangereasoncode"}}},"32":{"slot":32,"values":{"1":{"slot":1,"type":"STRING","value":"bookingdateflag"}}},"33":{"slot":33,"values":{"1":{"slot":1,"type":"STRING","value":"seatassignedflag"}}},"34":{"slot":34,"values":{"1":{"slot":1,"type":"STRING","value":"checkinflag"}}},"35":{"slot":35,"values":{"1":{"slot":1,"type":"STRING","value":"boardedflag"}}},"36":{"slot":36,"values":{"1":{"slot":1,"type":"STRING","value":"noshowflag"}}},"37":{"slot":37,"values":{"1":{"slot":1,"type":"STRING","value":"unboardedflag"}}},"38":{"slot":38,"values":{"1":{"slot":1,"type":"STRING","value":"checkoutflag"}}},"39":{"slot":39,"values":{"1":{"slot":1,"type":"STRING","value":"segmentaddedflag"}}},"40":{"slot":40,"values":{"1":{"slot":1,"type":"STRING","value":"segmentdroppedflag"}}},"41":{"slot":41,"values":{"1":{"slot":1,"type":"STRING","value":"segmentchangeflag"}}},"42":{"slot":42,"values":{"1":{"slot":1,"type":"STRING","value":"legaddedflag"}}},"43":{"slot":43,"values":{"1":{"slot":1,"type":"STRING","value":"legaddedtempflag"}}},"44":{"slot":44,"values":{"1":{"slot":1,"type":"STRING","value":"legdroppedflag"}}},"45":{"slot":45,"values":{"1":{"slot":1,"type":"STRING","value":"flightflownflag"}}},"46":{"slot":46,"values":{"1":{"slot":1,"type":"STRING","value":"createdttm"}}},"47":{"slot":47,"values":{"1":{"slot":1,"type":"STRING","value":"pjlvid"}}},"48":{"slot":48,"values":{"1":{"slot":1,"type":"STRING","value":"eventtype"}}},"49":{"slot":49,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"}}},"50":{"slot":50,"values":{"1":{"slot":1,"type":"STRING","value":"originaldeparturedate"}}}},"visible":true},"4":{"slot":4,"name":"Trim Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"64686":{"id":64686,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":710,"y":204,"width":32,"height":32,"inputConnectorIDs":[64687],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage.pnrpassengereventcalc"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pnrpassengereventcalc"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"scheduledarrivalflightflag"},"2":{"slot":2,"type":"STRING","value":"scheduledarrivalflightflag"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"actualarrivalflightflag"},"2":{"slot":2,"type":"STRING","value":"actualarrivalflightflag"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"scheduledarrivalinventorylegid"},"2":{"slot":2,"type":"STRING","value":"scheduledarrivalinventorylegid"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"actualarrivalinventorylegid"},"2":{"slot":2,"type":"STRING","value":"actualarrivalinventorylegid"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"scheduledstautc"},"2":{"slot":2,"type":"STRING","value":"scheduledstautc"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"scheduleactualstaminutedifference"},"2":{"slot":2,"type":"STRING","value":"scheduleactualstaminutedifference"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"},"2":{"slot":2,"type":"STRING","value":"passengerid"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"},"2":{"slot":2,"type":"STRING","value":"segmentid"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"},"2":{"slot":2,"type":"STRING","value":"legnumber"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"segmentid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"legnumber"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stage"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"64688":{"id":64688,"sourceID":64685,"targetID":64684},"64687":{"id":64687,"sourceID":64684,"targetID":64686}},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"64682":{"id":64682,"x":166,"y":-121,"width":728,"height":271,"text":"Add scheduled and actual final flights indicators for the passenger\n\nIdentify the final scheduled flight for each journey prior to the departure date\n-scheduledarrivalflightflag\n\nIdentify the final actual flight for each journey on the departure date\n-actualarrivalflightflag\n\nidentifies scheduled flight for same day departures\n\nidentifies scheduled flights when the inventoryleg was dropped after the booking\n\nonly include PD flights to determine scheduled and actual flights\n\nsort the scheduled and arrival flights based on segmentnumber, legnumber, and versionenddatetimeutc\n\nonly update the pnr and passengerids in the pnrpassengerlist\n\nupdated: 2019-11-21","colour":"e6e63c"},"64683":{"id":64683,"x":391,"y":171,"width":153,"height":150,"text":"\n\n\n\n\n\n\nlookup the inventorylegid for the first and latest for each journey","colour":"e6e63c"}},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"PNR - Scheduled and Final Flights","description":"","type":"TRANSFORMATION"}}