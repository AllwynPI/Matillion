{"job":{"components":{"88606":{"id":88606,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":262,"y":158,"width":32,"height":32,"inputConnectorIDs":[88608],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"customersurveypassengers"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"pegasus_customersurveypassengerlist"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"recordlocator"},"2":{"slot":2,"type":"STRING","value":"pnr"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"status"},"2":{"slot":2,"type":"STRING","value":"passengerstatus"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"passengerid"},"2":{"slot":2,"type":"STRING","value":"passengerid"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"personid"},"2":{"slot":2,"type":"STRING","value":"personid"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"customerid"},"2":{"slot":2,"type":"STRING","value":"customerid"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"emailaddress"},"2":{"slot":2,"type":"STRING","value":"emailaddress"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"firstname"},"2":{"slot":2,"type":"STRING","value":"displayfirstname"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"lastname"},"2":{"slot":2,"type":"STRING","value":"displaylastname"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"scheduledsenddate"},"2":{"slot":2,"type":"STRING","value":"scheduledsenddatetime"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"emailexpirationdate"},"2":{"slot":2,"type":"STRING","value":"emailexpirationdatetime"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"version"},"2":{"slot":2,"type":"STRING","value":"emailtemplateversion"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"flightdate"},"2":{"slot":2,"type":"STRING","value":"flightdatetime"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"flightdeparture"},"2":{"slot":2,"type":"STRING","value":"flightdeparture"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"flightdestination"},"2":{"slot":2,"type":"STRING","value":"flightdestination"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"csatsamplerate"},"2":{"slot":2,"type":"STRING","value":"csatsamplerate"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"scheduledsenddateutc"},"2":{"slot":2,"type":"STRING","value":"scheduledsenddatetimeutc"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"emailexpirationdateutc"},"2":{"slot":2,"type":"STRING","value":"emailexpirationdatetimeutc"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate"}}}},"visible":true},"6":{"slot":6,"name":"Automatic Compression","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"apps"}}}},"visible":true}},"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Message","mapTo":"Errormessage"}},"expectedFailure":null,"activationStatus":"ENABLED"},"88607":{"id":88607,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-177,"y":165,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[88608],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Random Sample"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT T.*\n \t, a.csatsamplerate\n FROM ( \n SELECT \t\n\t\t\t\trecordlocator\n     \t\t\t, c.customerid \n         \t\t, status\n         \t\t, COALESCE( epl.personid, 0) as personid\n   \t\t\t\t, epl.passengerid    \t\t\t\t\n         \t\t, public.f_formatemail(epl.email) as emailaddress \n         \t\t, public.f_formatemail(epl.toemailaddress) as toemailaddress\n         \t\t, epl.firstname\n         \t\t, epl.lastname\n\t\t\t\t, convert_timezone('America/Toronto', DATEADD(min, 15, DATEADD( hour, DATEPART(hour,getdate()), TRUNC( getdate()) ))) as scheduledsenddate\n         \t\t, convert_timezone('America/Toronto', epl.emailexpirationdateutc ) as emailexpirationdate    \t\t\n         \t\t, DATEADD(min, 15, DATEADD( hour, DATEPART(hour,getdate()), TRUNC( getdate()))) AS scheduledsenddateutc\n         \t\t, epl.emailexpirationdateutc\n         \t\t, epl.version         \t\t\n\t\t\t\t, CASE WHEN  epl.finaldeparturedate IS NULL or len( epl.finaldeparturedate) < 1 then '0001-01-01' else finaldeparturedate end  as flightdate\n\t\t\t\t, COALESCE( epl.flightdeparture, '') as flightdeparture\n         \t\t, COALESCE( epl.flightdestination, ' ') as flightdestination\n\t\t\t\t,  ntile(100::bigint) OVER(PARTITION BY  epl.scheduledsenddateutc,  epl.flightdeparture ORDER BY random()) \n         \t\t\t\tAS randompercentile\n\t\t\t\t, case when cplh.csatpassengerlistid is null then 0 else 1 end as previouslysampled\n\t\t\t\t, count(*) over (partition by scheduledsenddateutc, epl.flightdeparture) as originrecordcount\n           FROM etl.odscsat_passengerlist  epl\n\t\t   left join email.csat_surveryrecepientresults srr\n\t\t   on lower(epl.email) = lower(srr.emailaddress)\t\n\t\t   left join public.customer c\n\t\t   on  lower(epl.email) = lower(c.emailaddress)\t\n\t\t   left join email.customersurveypassengerhistory cplh\n\t\t   on epl.recordlocator = cplh.pnr\n\t\t\tand public.f_formatemail(epl.email)  = cplh.emailaddress\n\t\t\tand epl.passengerid = cplh.passengerid\t\t  \n\t   where (last_clicked < DateAdd(d, 30, scheduledsenddateutc) or last_clicked is null) \n\t\t   and c.SegmentIsAgent = 'N'\n\t\t   and c.emailcustomerrank = 1 \n\t\t   and cplh.csatpassengerlistid is null \n        \t\t) T \nJOIN public.airport a\non t.flightdeparture = a.airportcode\nwhere t.randompercentile <= CEIL((0.01 * csatsamplerate * originrecordcount))  \nand previouslysampled = 0"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"88608":{"id":88608,"sourceID":88607,"targetID":88606}},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"88604":{"id":88604,"x":-286,"y":70,"width":224,"height":123,"text":"Excludes people who have clicked an email survey link in the last 30 days and anyone marked as SegmentIsAgent in the Customer table based on email match and ECR = 1 "},"88605":{"id":88605,"x":-286,"y":214,"width":223,"height":71,"text":"The schedulesenddateutc is defined to be 15 minutes passed the hour the job runs"}},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"CSAT-IntradayLoad","description":"","type":"TRANSFORMATION"}}