{"job":{"components":{"62931":{"id":62931,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":112,"y":176,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[62933],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"set expiredatetimeutc"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"/*********************************************************************************\nsort the flights by changetimeutc to get the expired date for the previous record\n\t\nthe latest changetimeutc is the active record and the expiry date is 9999-12-31\n\nan active record for a flight number, flight date, departure station and arrival station\nregardless of the leghashkeys\n*********************************************************************************/\nselect \ncarriercode,flightnumber, flightdate, departurestation, arrivalstation, C.changetimeutc\n, (case when version_end_date='9999-12-31' \n   then version_end_date \n   /* updated 2019-11-17 else dateadd(s,-1,version_end_date) */\n   else dateadd(ms,-1,version_end_date) \n   end) expireddatetimeutc\nfrom\n(select --leghashkey,\n carriercode,flightnumber, flightdate, departurestation, arrivalstation, changetimeutc, \n (case when RANK_=1 then '9999-12-31' else \n  \tLAG(changetimeutc) over (partition by carriercode,flightnumber, flightdate, departurestation, arrivalstation order by RANK_) end) version_end_date\nfrom\n(select --distinct leghashkey,\n carriercode,flightnumber, flightdate, departurestation, arrivalstation,changetimeutc, \n rank() over(partition by carriercode,flightnumber, flightdate, departurestation, arrivalstation order by changetimeutc desc) RANK_ \nfrom\n(\nselect distinct --leghashkey, \n  carriercode, flightnumber, flightdate, departurestation, arrivalstation\n  , effectivedatetimeutc changetimeutc from public.flightdetailhistory AS fdh\nwhere activeflag = 1  \n\n AND EXISTS (SELECT 1 FROM etl.flightdetailupdate1 AS fdu\n\t\t\tWHERE fdu.carriercode = fdh.carriercode\n\t\t\tAND fdu.flightnumber= fdh.flightnumber\n\t\t\tAND fdu.flightdate= fdh.flightdate\n\t\t\tAND fdu.departurestation= fdh.departurestation\n\t\t\tAND fdu.arrivalstation= fdh.arrivalstation)\n\t\t\t\n) A\n) B\n) C\n\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"62932":{"id":62932,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":353,"y":182,"width":32,"height":32,"inputConnectorIDs":[62933],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"public.flightdetailhistory"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"flightdetailhistory"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"changetimeutc"},"2":{"slot":2,"type":"STRING","value":"effectivedatetimeutc"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"expireddatetimeutc"},"2":{"slot":2,"type":"STRING","value":"expireddatetimeutc"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"},"2":{"slot":2,"type":"STRING","value":"flightnumber"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"flightdate"},"2":{"slot":2,"type":"STRING","value":"flightdate"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"},"2":{"slot":2,"type":"STRING","value":"departurestation"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"},"2":{"slot":2,"type":"STRING","value":"arrivalstation"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"},"2":{"slot":2,"type":"STRING","value":"carriercode"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"flightdate"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"effectivedatetimeutc"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"public"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"62933":{"id":62933,"sourceID":62931,"targetID":62932}},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"62930":{"id":62930,"x":86,"y":24,"width":404,"height":77,"text":"Update the expireddatettimeutc on the flightdetailhistory table\n\nset the expiredatetime 1 millsecond before the next effectivedatetime\n\nupdated: 2019-11-17","colour":"e6e63c"}},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"OPS - FlightDetailsHistoryExpiredDateUpdate_Load (1)","description":"","type":"TRANSFORMATION"}}