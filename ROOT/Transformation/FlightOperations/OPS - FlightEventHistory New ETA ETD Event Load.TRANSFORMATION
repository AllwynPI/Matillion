{"job":{"components":{"53139":{"id":53139,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":224,"y":288,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[53152],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ETA Event"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select eventname, eventdescription, eventdatetimeutc, carriercode, flightnumber, flightdate, departurestation, arrivalstation\nfrom\n(select\n'ETA' as eventname --\n, (case when arrivaloveralldelaycode >'' then 'delay code: '||arrivaloveralldelaycode||'; '||'delay time: '||arrivaloveralldelaytime||'; '\n\t\twhen arrivaloveralldelaytime > 0 then 'delay code: '||arrivaloveralldelaycode||'; '||'delay time: '||arrivaloveralldelaytime||'; '\n\t\telse '' end) eventdescription\n, effectivedatetimeutc eventdatetimeutc \n, carriercode\n, flightnumber\n, flightdate\n, departurestation\n, arrivalstation\n, leghashkey\n, sta\n, eta\n, ( case when rank() over (partition by flightnumber, flightdate, departurestation, arrivalstation,leghashkey order by effectivedatetimeutc) =1 then eta\n\t\telse LAG(eta,1) ignore nulls over(partition by flightnumber, flightdate, departurestation, arrivalstation,leghashkey order by effectivedatetimeutc) end) last_ETA\n\nFROM public.flightdetailhistory \nwhere eta >'1900-01-01'\n--AND effectivedatetimeutc > '${maxetadatetime}' \n AND EXISTS (SELECT 1 FROM public.flightdetailhistory AS fd\n\t\t\tWHERE LEFT(fd.leghashkey,26) = LEFT(flightdetailhistory.leghashkey,26)\n\t\t\tAND fd.effectivedatetimeutc > '${maxetadatetime}'\n            --AND fd.flightdate >='2017-11-01' AND fd.flightdate < '2018-11-01'\n            -- AND fd.flightdate >='2018-10-01' --AND fd.flightdate < '2018-11-01'\n\t\t\t)  \nand flightdetailhistoryid not in (select flightdetailhistoryid from public.flightdetailhistory where iropcode like 'IR%')\n) ETD_EVENT\nwhere Eta<>last_ETa\ngroup by eventname, eventdescription, eventdatetimeutc, carriercode, flightnumber, flightdate, departurestation, arrivalstation"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53140":{"id":53140,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":224,"y":112,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[53154],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ETD Event"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT \n\teventname, eventdescription, eventdatetimeutc\n\t, carriercode, flightnumber, flightdate, departurestation, arrivalstation\nFROM\n(select\n\t'ETD' as eventname --\n\t, (case when departureoveralldelaycode >'' \n   \t\tthen 'delay code: '||departureoveralldelaycode||'; '||'delay time: '||departureoveralldelaytime||'; '\n\t\twhen departureoveralldelaytime >0 \n   \t\tthen 'delay code: '||departureoveralldelaycode||'; '||'delay time: '||departureoveralldelaytime||'; '\n\t\telse '' end) eventdescription\n\t, effectivedatetimeutc eventdatetimeutc \n\t, carriercode\n\t, flightnumber\n\t, flightdate\n\t, departurestation\n\t, arrivalstation\n\t, leghashkey\n\t, std\n\t, etd\n\t, ( case when rank() over (partition by flightnumber, flightdate, departurestation, arrivalstation,leghashkey order by effectivedatetimeutc) =1 \n   \t\tthen etd\n\t\telse LAG(etd,1) ignore nulls over(partition by flightnumber, flightdate, departurestation, arrivalstation,leghashkey order by effectivedatetimeutc) \n   end) last_ETD\nFROM public.flightdetailhistory \nWHERE etd > '1900-01-01' \n/* return all instances of a flight to rank the changes */\t\t\t\t\t\t\t\t  \nAND EXISTS (SELECT 1 FROM public.flightdetailhistory AS fd\n\t\t\tWHERE LEFT(fd.leghashkey,26) = LEFT(flightdetailhistory.leghashkey,26)\n\t\t\tAND fd.effectivedatetimeutc > '${maxetddatetime}'\n            --AND fd.flightdate >='2018-10-01' --AND fd.flightdate < '2018-11-01'\n\t\t\t)  \n/* do not include flights with return gate */\n and flightdetailhistoryid not in (select flightdetailhistoryid from public.flightdetailhistory \n                                  where iropcode like 'IR%')\n) ETD_EVENT\nwhere Etd <> last_ETD \ngroup by eventname, eventdescription, eventdatetimeutc, carriercode, flightnumber, flightdate, departurestation, arrivalstation"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53141":{"id":53141,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-1841822228,"x":864,"y":208,"width":32,"height":32,"inputConnectorIDs":[53159,53161,53150],"outputConnectorIDs":[53156],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"union all events"}}}},"visible":true},"2":{"slot":2,"name":"Method","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"All Columns"}}}},"visible":true},"3":{"slot":3,"name":"Cast Types","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Add Source Component Column","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Remove duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53142":{"id":53142,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":1248,"y":208,"width":32,"height":32,"inputConnectorIDs":[53151],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"public.flighteventhistory"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"flighteventhistory"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventname"},"2":{"slot":2,"type":"STRING","value":"eventname"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"eventdescription"},"2":{"slot":2,"type":"STRING","value":"eventdescription"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"eventdatetimeutc"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"},"2":{"slot":2,"type":"STRING","value":"carriercode"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"},"2":{"slot":2,"type":"STRING","value":"flightnumber"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"flightdate"},"2":{"slot":2,"type":"STRING","value":"flightdate"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"},"2":{"slot":2,"type":"STRING","value":"departurestation"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"},"2":{"slot":2,"type":"STRING","value":"arrivalstation"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"leghaskey"},"2":{"slot":2,"type":"STRING","value":"leghashkey"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventname"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"flightdate"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"public"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53143":{"id":53143,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":1104,"y":208,"width":32,"height":32,"inputConnectorIDs":[53156],"outputConnectorIDs":[53151],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"group eta etd events"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"-- Update query to join with the target table flightseventshistroy \n-- and filter out any records from the data set that are already exisitng inthe target\n\n\nselect\n\tNEH.eventname\n\t,NEH.eventdescription\n\t,NEH.eventdatetimeutc \n    ,NEH.flightnumber\n    ,NEH.flightdate\n    ,NEH.departurestation \n    ,NEH.arrivalstation\n    ,NEH.carriercode\n    ,NEH.leghaskey\nFROM\n(\n\tselect distinct eventname,\n\t  listagg(eventdescription,';') within group (order by eventdatetimeutc) as eventdescription,\n      a.eventdatetimeutc, \n      a.flightnumber,\n      a.flightdate,\n      a.departurestation, \n      a.arrivalstation,\n      a.carriercode,\n      '' as leghaskey\nfrom $T{union all events} a\ngroup by eventname,\n         a.eventdatetimeutc,\n         a.flightnumber,\n         a.flightdate,\n         a.departurestation,\n         a.arrivalstation,\n         a.carriercode\n) NEH where NEH.eventname in ('ETD','ETA') and NOT EXISTS (Select * from public.flighteventhistory dup\n\t  WHERE dup.eventdatetimeutc = NEH.eventdatetimeutc\n\t\tAND dup.carriercode = NEH.carriercode\n\t\tAND dup.flightnumber = NEH.flightnumber\n\t\tAND dup.flightdate = NEH.flightdate\n\t\tAND dup.departurestation = NEH.departurestation\n\t\tAND dup.arrivalstation = NEH.arrivalstation\n\t\tAND dup.eventname = 'ETD/ETA')\n\n\n\n\n\n\n\n\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53144":{"id":53144,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":624,"y":112,"width":32,"height":32,"inputConnectorIDs":[53153,53149],"outputConnectorIDs":[53161],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ETD/ETA"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select 'ETD/ETA' as eventname, etd.eventdescription||';'||eta.eventdescription as eventdescription, \netd.eventdatetimeutc, \netd.carriercode, \netd.flightnumber, \netd.flightdate,\netd.departurestation, \netd.arrivalstation\nfrom $T{Replicate ETD} as etd\n\tinner join\n\t$T{Replicate ETA} as eta \n\ton (etd.eventdatetimeutc = eta.eventdatetimeutc and\n    \tetd.flightnumber = eta.flightnumber and \n    \tetd.flightdate = eta.flightdate and \n    \tetd.departurestation = eta.departurestation and \n        etd.arrivalstation = eta.arrivalstation)"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53145":{"id":53145,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":624,"y":208,"width":32,"height":32,"inputConnectorIDs":[53158,53160],"outputConnectorIDs":[53150],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ETD"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select eventname, \n\t   eventdescription,\n       eventdatetimeutc,\n       carriercode,\n       flightnumber,\n       flightdate,\n       departurestation,\n       arrivalstation\n       --,eta_departurestation\n       from\n          (select 'ETD' as eventname,\n                \t\t   etd.eventdescription,\n                           etd.eventdatetimeutc,\n                           etd.carriercode,\n                           etd.flightnumber,\n                           etd.flightdate,\n                           etd.departurestation,\n                           etd.arrivalstation,\n                           NVL(eta.departurestation, 'N/A') eta_departurestation\n                            from $T{Replicate ETD} as etd\n                           left outer join\n                                 $T{Replicate ETA} as eta \n                                 on ( etd.eventdatetimeutc = eta.eventdatetimeutc and\n                                      etd.flightnumber = eta.flightnumber and\n                                      etd.flightdate = eta.flightdate and  \n                                      etd.departurestation = eta.departurestation and \n                                      etd.arrivalstation = eta.arrivalstation ) )\n                          where eta_departurestation  = 'N/A'           \n--                        where isnull(eta_departurestation,'N/A') = 'N/A'  --and eventdatetimeutc >'2019-10-01'\n                         \n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53146":{"id":53146,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":624,"y":288,"width":32,"height":32,"inputConnectorIDs":[53155,53157],"outputConnectorIDs":[53159],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ETA"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select eventname\n\t , eventdescription\n     , eventdatetimeutc\n     , carriercode\n     , flightnumber\n     , flightdate\n     , departurestation\n     , arrivalstation\n--,etd_departurestation \nfrom\n\t(select 'ETA' as eventname,\n     eta.eventdescription,\n     eta.eventdatetimeutc,\n     eta.carriercode,\n     eta.flightnumber, \n     eta.flightdate,\n     eta.departurestation, \n     eta.arrivalstation,\n \t NVL(etd.departurestation,'N/A') etd_departurestation\n     from $T{Replicate ETD} as etd\n      right outer join\n      $T{Replicate ETA} as eta \n      \ton (etd.eventdatetimeutc = eta.eventdatetimeutc and \n            etd.flightnumber = eta.flightnumber and\n            etd.flightdate = eta.flightdate and \n            etd.departurestation = eta.departurestation and \n            etd.arrivalstation = eta.arrivalstation ) )\n    where etd_departurestation = 'N/A'         \n--\twhere isnull(etd_departurestation,'N/A') = 'N/A'  -- and eventdatetimeutc >'2019-11-01'\n    \n    "}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53147":{"id":53147,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":-1949249710,"x":352,"y":112,"width":32,"height":32,"inputConnectorIDs":[53154],"outputConnectorIDs":[53155,53158,53149],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Replicate ETD"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53148":{"id":53148,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":-1949249710,"x":352,"y":288,"width":32,"height":32,"inputConnectorIDs":[53152],"outputConnectorIDs":[53153,53157,53160],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Replicate ETA"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"53152":{"id":53152,"sourceID":53139,"targetID":53148},"53153":{"id":53153,"sourceID":53148,"targetID":53144},"53154":{"id":53154,"sourceID":53140,"targetID":53147},"53155":{"id":53155,"sourceID":53147,"targetID":53146},"53156":{"id":53156,"sourceID":53141,"targetID":53143},"53157":{"id":53157,"sourceID":53148,"targetID":53146},"53158":{"id":53158,"sourceID":53147,"targetID":53145},"53159":{"id":53159,"sourceID":53146,"targetID":53141},"53160":{"id":53160,"sourceID":53148,"targetID":53145},"53161":{"id":53161,"sourceID":53144,"targetID":53141},"53149":{"id":53149,"sourceID":53147,"targetID":53144},"53150":{"id":53150,"sourceID":53145,"targetID":53141},"53151":{"id":53151,"sourceID":53143,"targetID":53142}},"canUndo":true,"undoCommand":"Set Parameter","undoCreated":1578926533032,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"53137":{"id":53137,"x":206,"y":-8,"width":250,"height":58,"text":"Identify new ETD, ETA or ETD/ETA events\n\nupdated:2019-12-05","colour":"e6e63c"},"53138":{"id":53138,"x":557,"y":22,"width":148,"height":124,"text":"merge the ETA & ETD events with the same eventdatetimeutc into a single event","colour":"e6e63c"}},"noteConnectors":{},"variables":{"maxetadatetime":{"definition":{"name":"maxetadatetime","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"2019-10-01"},"maxetddatetime":{"definition":{"name":"maxetddatetime","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"2019-10-01"}},"grids":{}},"info":{"name":"OPS - FlightEventHistory New ETA ETD Event Load","description":"","type":"TRANSFORMATION"}}