{"job":{"components":{"53131":{"id":53131,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":256,"y":208,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[53134],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STG"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT DISTINCT B.effectivedatetimeutc, B.expireddatetimeutc, B.Leghashkey,B.carriercode, B.flightdate, B.flightnumber, B.departurestation,\nB.arrivalstation, B.uncorrectedtailnumber,B.outtime, B.offtime,B.ontime, B.intime, iropcode ,\nLEAD(B.arrivalstation,1) OVER (PARTITION BY B.carriercode, B.flightdate, B.flightnumber, B.departurestation order by B.effectivedatetimeutc asc) next_arrivalstation\nFROM public.flightdetailhistory B \nINNER JOIN\n(\nSELECT * FROM (\n\tSELECT fdh.carriercode, fdh.flightdate, fdh.flightnumber,fdh.departurestation, count( distinct fdh.arrivalstation) cnt\n\tFROM public.flightdetailhistory fdh\n\tWHERE fdh.departurestation <> fdh.arrivalstation\n     AND EXISTS (\n\t\tSELECT 1 \n\t\tFROM public.flightdetailhistory AS fd \n\t\tWHERE LEFT(fd.leghashkey,26) =  LEFT(fdh.leghashkey,26)\n\t\tAND fd.effectivedatetimeutc > '${lasttimediversion}'\n         )      \n\t\t\tGROUP BY fdh.carriercode, fdh.flightdate, fdh.flightnumber, fdh.departurestation\n\t\t\tHAVING COUNT(DISTINCT fdh.arrivalstation) >1) A ) C\n\t\t\ton (  B.carriercode = C.carriercode \n\t\t\tAND\t  B.flightdate = C.flightdate \n\t\t\tAND   B.flightnumber = C.flightnumber \n\t\t\tAND   B.departurestation = C.departurestation) \n\t\t    WHERE B.effectivedatetimeutc >= B.flightdate\n            --and B.flightnumber=397 and B.flightdate='2019-10-20 00:00:00'\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53132":{"id":53132,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":432,"y":208,"width":32,"height":32,"inputConnectorIDs":[53134],"outputConnectorIDs":[53135],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"transform"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select 'DIVERSION' eventname, '' eventdescription, effectivedatetimeutc eventdatetimeutc, carriercode, flightnumber, flightdate, departurestation, \nsubstring(Leghashkey,24,3) arrivalstation, leghashkey, getdate() createdttm\nfrom \n(select D.*,\n  \trank() over(partition by carriercode, flightdate, flightnumber, departurestation\n  \torder by effectivedatetimeutc asc) as RANK__\n\tfrom $T{STG} D \n    where arrivalstation<> next_arrivalstation\n   AND leghashkey not in (select distinct leghashkey from $T{STG} where iropcode like 'X%')) as E\nWHERE   RANK__= 1\n\n\n\n\n\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"53133":{"id":53133,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":-1848704949,"x":624,"y":208,"width":32,"height":32,"inputConnectorIDs":[53135],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"flighteventhistory"}}}},"visible":true},"2":{"slot":2,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"flighteventhistory"}}}},"visible":true},"3":{"slot":3,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventname"},"2":{"slot":2,"type":"STRING","value":"eventname"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"eventdescription"},"2":{"slot":2,"type":"STRING","value":"eventdescription"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"eventdatetimeutc"},"2":{"slot":2,"type":"STRING","value":"eventdatetimeutc"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"},"2":{"slot":2,"type":"STRING","value":"carriercode"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"},"2":{"slot":2,"type":"STRING","value":"flightnumber"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"flightdate"},"2":{"slot":2,"type":"STRING","value":"flightdate"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"},"2":{"slot":2,"type":"STRING","value":"departurestation"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"arrivalstation"},"2":{"slot":2,"type":"STRING","value":"arrivalstation"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"leghashkey"},"2":{"slot":2,"type":"STRING","value":"leghashkey"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"createdttm"},"2":{"slot":2,"type":"STRING","value":"createdttm"}}}},"visible":true},"5":{"slot":5,"name":"Unique Keys","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"eventname"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"carriercode"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"flightnumber"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"flightdate"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"departurestation"}}}},"visible":true},"6":{"slot":6,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"public"}}}},"visible":true},"7":{"slot":7,"name":"Update Strategy","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Delete/Insert"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"53134":{"id":53134,"sourceID":53131,"targetID":53132},"53135":{"id":53135,"sourceID":53132,"targetID":53133}},"canUndo":true,"undoCommand":"Set Parameter","undoCreated":1580828843638,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"53128":{"id":53128,"x":162,"y":7,"width":480,"height":75,"text":"This Job identifies the flights which has been diverted from original destination to a new one","colour":"e6e63c"},"53129":{"id":53129,"x":161,"y":147,"width":182,"height":141,"text":"Extracting records\n","colour":"e6e63c"},"53130":{"id":53130,"x":550,"y":141,"width":179,"height":150,"text":"Update/Insert records","colour":"e6e63c"}},"noteConnectors":{},"variables":{"lasttimediversion":{"definition":{"name":"lasttimediversion","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"2018-01-01"}},"grids":{}},"info":{"name":"OPS - FlightDiversion_Load","description":null,"type":"TRANSFORMATION"}}