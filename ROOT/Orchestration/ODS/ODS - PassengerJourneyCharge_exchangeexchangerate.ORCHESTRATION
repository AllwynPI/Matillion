{"job":{"components":{"27175":{"id":27175,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-766,"y":7,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[27177],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"27176":{"id":27176,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-741198691,"x":-446,"y":1,"width":32,"height":32,"inputConnectorIDs":[27177],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Message","mapTo":"Errormessage"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"rez_passengerjourneycharge"}}}},"visible":true},"2":{"slot":2,"name":"Database Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Microsoft SQL Server"}}}},"visible":true},"3":{"slot":3,"name":"Connection URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${db_server_url_ods_rezpdod01}"}}}},"visible":true},"6":{"slot":6,"name":"Usename","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${db_user_ods_rezpdod01}"}}}},"visible":true},"7":{"slot":7,"name":"Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"PASSWORD","value":"${db_pswd_ods_rezpdod01}"}}}},"visible":true},"8":{"slot":8,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SELECT  * \n\t, REFPDOD01.reference.ConvertUTCtoTZ('CA3', CreatedUTC) AS CreatedEST\n\t, CASE WHEN ForeignCurrencyCode <> 'CAD' \n\t\tTHEN REFPDOD01.reference.ConvertCurrency(chargeamount, ForeignCurrencyCode, 'CAD', 'PD', CAST(CONVERT(varchar(20), CreatedUTC) AS datetime) )\n\t  ELSE ChargeAmount\n\t  END AS ChargeAmountCAD\n\t, CASE \n\t\tWHEN ForeignCurrencyCode = 'CAD'  AND Currencycode = 'USD'\n\t\t\tTHEN --REFPDOD01.reference.ConvertCurrency(1, 'USD', 'CAD', 'PD', CAST(CONVERT(varchar(20), CreatedUTC) AS datetime) ) \n            \t/* check if the exchange rate returns 1 , if so add 5 minutes to the time to get the next exchange rate */\n                (CASE WHEN REFPDOD01.reference.ConvertCurrency(1, 'USD', 'CAD', 'PD', CreatedUTC ) = 1.0\n\t\t\t\tTHEN REFPDOD01.reference.ConvertCurrency(1, 'USD', 'CAD', 'PD', DATEADD(mi,5,CreatedUTC) ) \n\t\t\t\tELSE REFPDOD01.reference.ConvertCurrency(1, 'USD', 'CAD', 'PD',  CreatedUTC ) \n\t\t\t\tEND)\n        WHEN ForeignCurrencyCode = 'CAD'  AND Currencycode = 'CAD'\n\t\t\tTHEN 1.00\n\t    WHEN ForeignCurrencyCode <> 'CAD' \n\t\t\tTHEN --REFPDOD01.reference.ConvertCurrency(1, ForeignCurrencyCode, 'CAD', 'PD',CAST(CONVERT(varchar(20), CreatedUTC) AS datetime) )\n            \t/* check if the exchange rate returns 1 , if so add 5 minute to the time to get the next exchange rate */\n            \t(CASE WHEN REFPDOD01.reference.ConvertCurrency(1, ForeignCurrencyCode, 'CAD', 'PD', CreatedUTC ) = 1.0\n\t\t\t\tTHEN REFPDOD01.reference.ConvertCurrency(1, ForeignCurrencyCode, 'CAD', 'PD', DATEADD(mi,5,CreatedUTC) )\n\t\t\t\tELSE REFPDOD01.reference.ConvertCurrency(1, ForeignCurrencyCode, 'CAD', 'PD', CreatedUTC )\n\t\t\t\tEND)\n\t  ELSE 1.00\n\t  END AS ExchangeRate\nFROM rez.PassengerJourneyCharge pjc\nWHERE currencycode <> foreigncurrencycode\nAND createdutc BETWEEN '2018-08-01' AND '2018-10-30'\nAND passengerid = 16107972\t\t\t\t\nAND segmentid = 32751524\n"}}}},"visible":true},"9":{"slot":9,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"PassengerJourneyCharge"}}}},"visible":true},"10":{"slot":10,"name":"S3 Staging Area","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"porterdatawarehouse"}}}},"visible":true},"11":{"slot":11,"name":"Connection Options","elements":{},"visible":true},"12":{"slot":12,"name":"Concurrency","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"6"}}}},"visible":true},"13":{"slot":13,"name":"Distribution Style","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Even"}}}},"visible":true},"14":{"slot":14,"name":"Distribution Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"15":{"slot":15,"name":"Sort Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"PassengerID"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"SegmentID"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"ChargeNumber"}}}},"visible":true},"16":{"slot":16,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"etl"}}}},"visible":true},"17":{"slot":17,"name":"Sort Key Options","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Compound"}}}},"visible":true},"96":{"slot":96,"name":"Location","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"s3://<bucket>/<path>"}}}},"visible":false},"97":{"slot":97,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"98":{"slot":98,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"99":{"slot":99,"name":"Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Standard"}}}},"visible":true},"1001":{"slot":1001,"name":"HIDDEN","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":" drop table if exists \"etl\".\"PassengerJourneyCharge\" cascade; create table \"etl\".\"PassengerJourneyCharge\" (\n\t\"PassengerID\" DECIMAL(19, 0),\n\t\"SegmentID\" DECIMAL(19, 0),\n\t\"ChargeNumber\" DECIMAL(5, 0),\n\t\"CreatedUserID\" DECIMAL(19, 0),\n\t\"CreatedUTC\" DATETIME,\n\t\"ChargeType\" DECIMAL(5, 0),\n\t\"ChargeCode\" VARCHAR(6),\n\t\"TicketCode\" VARCHAR(3),\n\t\"CurrencyCode\" VARCHAR(3),\n\t\"ChargeAmount\" DECIMAL(19, 4),\n\t\"ChargeDetail\" VARCHAR(10),\n\t\"ForeignCurrencyCode\" VARCHAR(3),\n\t\"ForeignAmount\" DECIMAL(19, 4),\n\t\"CreatedEST\" DATETIME,\n\t\"ChargeAmountCAD\" DECIMAL(19, 4),\n\t\"ExchangeRate\" DECIMAL(19, 4)\n) DISTSTYLE EVEN"}}}},"visible":false},"1034":{"slot":1034,"name":"Load Options","elements":{},"visible":true},"40000":{"slot":40000,"name":"Encryption","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":true},"40001":{"slot":40001,"name":"KMS Key ID","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{},"unconditionalConnectors":{"27177":{"id":27177,"sourceID":27175,"targetID":27176}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"canUndo":false,"undoCommand":"","undoCreated":-1,"canRedo":false,"redoCommand":"","redoCreated":-1,"notes":{"27174":{"id":27174,"x":-780,"y":-177,"width":285,"height":105,"text":"Extracts new, updated and delete records from the ODS REZ database\n\nuses variables to connect to the ODS database\n\nupdate:2018-10-30\n\nadded where clause to exclude skyledger updates to get the mad modified date","colour":"e6e63c"}},"variables":{},"grids":{}},"info":{"name":"ODS - PassengerJourneyCharge_exchangeexchangerate","description":"","type":"ORCHESTRATION"}}